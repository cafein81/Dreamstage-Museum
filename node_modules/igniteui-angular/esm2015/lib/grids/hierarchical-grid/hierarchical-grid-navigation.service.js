/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { IgxGridNavigationService } from '../grid-navigation.service';
import { first } from 'rxjs/operators';
import { FilterMode } from '../grid-base.component';
export class IgxHierarchicalGridNavigationService extends IgxGridNavigationService {
    /**
     * @protected
     * @param {?=} visibleIndex
     * @param {?=} isSummary
     * @return {?}
     */
    getCellSelector(visibleIndex, isSummary = false) {
        return isSummary ? 'igx-grid-summary-cell' : 'igx-hierarchical-grid-cell';
    }
    /**
     * @protected
     * @return {?}
     */
    getRowSelector() {
        return 'igx-hierarchical-grid-row';
    }
    /**
     * @protected
     * @param {?} index
     * @return {?}
     */
    getRowByIndex(index) {
        /** @type {?} */
        const selector = this.getRowSelector();
        /** @type {?} */
        const rows = Array.from(this.grid.nativeElement.querySelectorAll(`${selector}[data-rowindex="${index}"]`));
        /** @type {?} */
        let row;
        rows.forEach((r) => {
            /** @type {?} */
            const parentGrid = this.getClosestElemByTag(r, 'igx-hierarchical-grid');
            if (parentGrid && parentGrid.getAttribute('id') === this.grid.id) {
                row = r;
            }
        });
        return row;
    }
    /**
     * @private
     * @param {?=} grid
     * @return {?}
     */
    getChildContainer(grid) {
        /** @type {?} */
        const currGrid = grid || this.grid;
        return currGrid.nativeElement.parentNode.parentNode.parentNode;
    }
    /**
     * @private
     * @param {?=} grid
     * @return {?}
     */
    getChildGridRowContainer(grid) {
        /** @type {?} */
        const currGrid = grid || this.grid;
        return currGrid.nativeElement.parentNode.parentNode;
    }
    /**
     * @private
     * @param {?} childGridID
     * @param {?} grid
     * @return {?}
     */
    getChildGrid(childGridID, grid) {
        /** @type {?} */
        const cgrid = grid.hgridAPI.getChildGrids(true).filter((g) => g.id === childGridID)[0];
        return cgrid;
    }
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    _isScrolledToBottom(grid) {
        /** @type {?} */
        const scrollTop = grid.verticalScrollContainer.getVerticalScroll().scrollTop;
        /** @type {?} */
        const scrollHeight = grid.verticalScrollContainer.getVerticalScroll().scrollHeight;
        return scrollHeight === 0 || Math.round(scrollTop + grid.verticalScrollContainer.igxForContainerSize) === scrollHeight;
    }
    /**
     * @private
     * @param {?} index
     * @return {?}
     */
    getIsChildAtIndex(index) {
        return this.grid.isChildGridRecord(this.grid.verticalScrollContainer.igxForOf[index]);
    }
    /**
     * @param {?} rowIndex
     * @param {?} visibleColumnIndex
     * @param {?=} isSummary
     * @return {?}
     */
    getCellElementByVisibleIndex(rowIndex, visibleColumnIndex, isSummary = false) {
        /** @type {?} */
        const cellSelector = this.getCellSelector(visibleColumnIndex, isSummary);
        if (isSummary) {
            /** @type {?} */
            const summaryRow = this.grid.summariesRowList.toArray()[0].nativeElement;
            return summaryRow.querySelector(`${cellSelector}[data-visibleIndex="${visibleColumnIndex}"]`);
        }
        /** @type {?} */
        const row = this.getRowByIndex(rowIndex);
        return row.querySelector(`${cellSelector}[data-rowindex="${rowIndex}"][data-visibleIndex="${visibleColumnIndex}"]`);
    }
    /**
     * @param {?} rowElement
     * @param {?} selectedNode
     * @return {?}
     */
    navigateUp(rowElement, selectedNode) {
        /** @type {?} */
        const prevElem = rowElement.previousElementSibling;
        /** @type {?} */
        const visibleColumnIndex = selectedNode.column;
        /** @type {?} */
        const currentRowIndex = selectedNode.row;
        if (prevElem) {
            /** @type {?} */
            const nodeName = prevElem.children[0].nodeName.toLowerCase();
            /** @type {?} */
            const isElemChildGrid = nodeName.toLowerCase() === 'igx-child-grid-row';
            if (isElemChildGrid) {
                this.focusPrevChild(prevElem, visibleColumnIndex, this.grid);
            }
            else {
                if (this.grid.parent !== null) {
                    // currently navigating in child grid
                    this._navigateUpInChild(rowElement, currentRowIndex, visibleColumnIndex);
                }
                else {
                    super.navigateUp(rowElement, selectedNode);
                }
            }
        }
        else if (currentRowIndex !== 0) {
            // handle scenario when prev item is child grid but is not yet in view
            /** @type {?} */
            const isPrevChildGrid = this.getIsChildAtIndex(currentRowIndex - 1);
            if (!isPrevChildGrid) {
                super.navigateUp(rowElement, selectedNode);
            }
            else {
                this.scrollGrid(this.grid, -rowElement.offsetHeight, () => {
                    rowElement = this.getRowByIndex(currentRowIndex);
                    this.navigateUp(rowElement, selectedNode);
                });
            }
        }
        else if (this.grid.parent !== null &&
            currentRowIndex === 0) {
            // move to prev row in sibling layout or parent
            this.focusPrev(visibleColumnIndex);
        }
    }
    /**
     * @param {?} rowElement
     * @param {?} selectedNode
     * @return {?}
     */
    navigateDown(rowElement, selectedNode) {
        /** @type {?} */
        const nextElem = rowElement.nextElementSibling;
        /** @type {?} */
        const visibleColumnIndex = selectedNode.column;
        /** @type {?} */
        const currentRowIndex = selectedNode.row;
        if (nextElem) {
            // next elem is in DOM
            /** @type {?} */
            const nodeName = nextElem.children[0].nodeName.toLowerCase();
            /** @type {?} */
            const isNextElemChildGrid = nodeName.toLowerCase() === 'igx-child-grid-row';
            if (isNextElemChildGrid) {
                this.focusNextChild(nextElem, visibleColumnIndex, this.grid);
            }
            else {
                if (this.grid.parent !== null) {
                    // currently navigating in child grid
                    this._navigateDownInChild(rowElement, currentRowIndex, visibleColumnIndex);
                }
                else {
                    super.navigateDown(rowElement, selectedNode);
                }
            }
        }
        else if (currentRowIndex !== this.grid.verticalScrollContainer.igxForOf.length - 1) {
            // scroll next in view
            super.navigateDown(rowElement, selectedNode);
        }
        else if (this.grid.parent !== null &&
            currentRowIndex === this.grid.verticalScrollContainer.igxForOf.length - 1) {
            // move to next row in sibling layout or in parent
            this.focusNext(visibleColumnIndex);
        }
    }
    /**
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    navigateTop(visibleColumnIndex) {
        if (this.grid.parent !== null) {
            // navigating in child
            /** @type {?} */
            const verticalScroll = this.grid.verticalScrollContainer.getVerticalScroll();
            /** @type {?} */
            const cellSelector = this.getCellSelector(visibleColumnIndex);
            if (verticalScroll.scrollTop === 0) {
                this._focusScrollCellInView(visibleColumnIndex);
            }
            else {
                this.scrollGrid(this.grid, 'top', () => {
                    /** @type {?} */
                    const cells = this.grid.nativeElement.querySelectorAll(`${cellSelector}[data-visibleIndex="${visibleColumnIndex}"]`);
                    if (cells.length > 0) {
                        this._focusScrollCellInView(visibleColumnIndex);
                    }
                });
            }
        }
        else {
            super.navigateTop(visibleColumnIndex);
        }
    }
    /**
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    navigateBottom(visibleColumnIndex) {
        // handle scenario where last index is child grid
        // in that case focus cell in last data row
        /** @type {?} */
        const lastIndex = this.grid.verticalScrollContainer.igxForOf.length - 1;
        if (this.getIsChildAtIndex(lastIndex)) {
            /** @type {?} */
            const targetIndex = lastIndex - 1;
            /** @type {?} */
            const scrTopPosition = this.grid.verticalScrollContainer.getScrollForIndex(targetIndex, true);
            /** @type {?} */
            const verticalScroll = this.grid.verticalScrollContainer.getVerticalScroll();
            /** @type {?} */
            const cellSelector = this.getCellSelector(visibleColumnIndex);
            if (verticalScroll.scrollTop === scrTopPosition) {
                /** @type {?} */
                const cells = this.getRowByIndex(targetIndex).querySelectorAll(`${cellSelector}[data-visibleIndex="${visibleColumnIndex}"]`);
                cells[cells.length - 1].focus();
            }
            else {
                this.scrollGrid(this.grid, scrTopPosition - verticalScroll.scrollTop, () => {
                    /** @type {?} */
                    const cells = this.getRowByIndex(targetIndex).querySelectorAll(`${cellSelector}[data-visibleIndex="${visibleColumnIndex}"]`);
                    if (cells.length > 0) {
                        cells[cells.length - 1].focus();
                    }
                });
            }
        }
        else {
            super.navigateBottom(visibleColumnIndex);
        }
    }
    /**
     * @return {?}
     */
    goToLastCell() {
        // handle scenario where last index is child grid
        // in that case focus last cell in last data row
        /** @type {?} */
        const lastIndex = this.grid.verticalScrollContainer.igxForOf.length - 1;
        if (this.getIsChildAtIndex(lastIndex)) {
            /** @type {?} */
            const targetIndex = lastIndex - 1;
            /** @type {?} */
            const scrTopPosition = this.grid.verticalScrollContainer.getScrollForIndex(targetIndex, true);
            /** @type {?} */
            const verticalScroll = this.grid.verticalScrollContainer.getVerticalScroll();
            if (verticalScroll.scrollTop === scrTopPosition) {
                this.onKeydownEnd(targetIndex);
            }
            else {
                this.scrollGrid(this.grid, scrTopPosition - verticalScroll.scrollTop, () => {
                    this.onKeydownEnd(targetIndex);
                });
            }
        }
        else {
            super.goToLastCell();
        }
    }
    /**
     * @param {?} rowIndex
     * @param {?=} isSummary
     * @return {?}
     */
    onKeydownEnd(rowIndex, isSummary = false) {
        if (this.grid.parent && !isSummary) {
            // handle scenario where last child row might not be in view
            // parent should scroll to child grid end
            /** @type {?} */
            const childContainer = this.grid.nativeElement.parentNode.parentNode;
            /** @type {?} */
            const diffBottom = childContainer.getBoundingClientRect().bottom - this.grid.rootGrid.nativeElement.getBoundingClientRect().bottom;
            /** @type {?} */
            const row = this.grid.getRowByIndex(rowIndex).element.nativeElement;
            /** @type {?} */
            const rowBottom = row.getBoundingClientRect().bottom;
            /** @type {?} */
            const rowIsVisible = rowBottom <= this.grid.rootGrid.tbody.nativeElement.getBoundingClientRect().bottom;
            /** @type {?} */
            const gridTop = this._getMaxTop(this.grid);
            /** @type {?} */
            const diffTop = row.getBoundingClientRect().bottom -
                row.offsetHeight - gridTop;
            /** @type {?} */
            const endIsVisible = diffBottom <= 0;
            /** @type {?} */
            const topVisible = diffTop >= 0;
            if (!endIsVisible && !rowIsVisible) {
                this.scrollGrid(this.grid.parent, diffBottom, () => super.onKeydownEnd(rowIndex));
            }
            else if (!topVisible) {
                /** @type {?} */
                const scrGrid = this.grid.verticalScrollContainer.getVerticalScroll().scrollTop !== 0 ? this.grid :
                    this.getNextScrollable(this.grid).grid;
                /** @type {?} */
                const topGrid = scrGrid.tbody.nativeElement.getBoundingClientRect().top >
                    this.grid.rootGrid.tbody.nativeElement.getBoundingClientRect().top ? scrGrid : this.grid.rootGrid;
                this.scrollGrid(topGrid, diffTop, () => super.onKeydownEnd(rowIndex));
            }
            else {
                super.onKeydownEnd(rowIndex, isSummary);
            }
        }
        else {
            super.onKeydownEnd(rowIndex, isSummary);
        }
    }
    /**
     * @return {?}
     */
    goToFirstCell() {
        /** @type {?} */
        const verticalScroll = this.grid.verticalScrollContainer.getVerticalScroll();
        /** @type {?} */
        const horizontalScroll = this.grid.dataRowList.first.virtDirRow.getHorizontalScroll();
        if (verticalScroll.scrollTop === 0 && this.grid.parent) {
            // scroll parent so that current child is in view
            if (!horizontalScroll.clientWidth || parseInt(horizontalScroll.scrollLeft, 10) <= 1 || this.grid.pinnedColumns.length) {
                this.navigateTop(0);
            }
            else {
                this.horizontalScroll(this.grid.dataRowList.first.index).scrollTo(0);
                this.grid.parentVirtDir.onChunkLoad
                    .pipe(first())
                    .subscribe(() => {
                    this.navigateTop(0);
                });
            }
        }
        else {
            super.goToFirstCell();
        }
    }
    /**
     * @param {?} currentRowEl
     * @param {?} selectedNode
     * @return {?}
     */
    performTab(currentRowEl, selectedNode) {
        /** @type {?} */
        const rowIndex = selectedNode.row;
        /** @type {?} */
        const visibleColumnIndex = selectedNode.column;
        /** @type {?} */
        const isSummaryRow = selectedNode.isSummaryRow;
        /** @type {?} */
        const summaryRows = this.grid.summariesRowList.toArray();
        /** @type {?} */
        const hasSummaries = summaryRows.length > 0;
        /** @type {?} */
        const isLastDataRow = rowIndex === this.grid.verticalScrollContainer.igxForOf.length - 1;
        /** @type {?} */
        const nextIsDataRow = this.grid.dataRowList.find(row => row.index === rowIndex + 1);
        /** @type {?} */
        const isLastColumn = this.grid.unpinnedColumns[this.grid.unpinnedColumns.length - 1].visibleIndex === visibleColumnIndex;
        /** @type {?} */
        const isLastSummaryRow = hasSummaries && isSummaryRow;
        /** @type {?} */
        const nextIndex = rowIndex + 1;
        /** @type {?} */
        const virt = this.grid.verticalScrollContainer;
        /** @type {?} */
        const isNextChild = nextIndex <= virt.igxForOf.length - 1 &&
            this.grid.isChildGridRecord(virt.igxForOf[nextIndex]);
        if (!nextIsDataRow && !(isLastDataRow && hasSummaries) && isLastColumn && !isSummaryRow) {
            // navigating in child, next is not summary
            /** @type {?} */
            const childContainer = this.getChildGridRowContainer();
            /** @type {?} */
            const nextIsSiblingChild = this.grid.parent ? !!childContainer.nextElementSibling : false;
            if (nextIsSiblingChild) {
                this.focusNextChildDOMElem(childContainer, this.grid.parent);
            }
            else if (isNextChild) {
                /** @type {?} */
                const isInView = virt.state.startIndex + virt.state.chunkSize > nextIndex;
                if (!isInView) {
                    this.scrollGrid(this.grid, 'next', () => {
                        this.focusNextChildDOMElem(currentRowEl, this.grid);
                    });
                }
                else {
                    this.focusNextChildDOMElem(currentRowEl, this.grid);
                }
            }
            else {
                this.navigateDown(currentRowEl, { row: rowIndex, column: 0 });
            }
        }
        else if (isLastSummaryRow && isLastColumn && this.grid.parent) {
            // navigating in child summary, next is parent summary or next parent row
            /** @type {?} */
            const parent = this.grid.parent;
            /** @type {?} */
            const parentHasSummary = parent.summariesRowList.toArray().length > 0;
            /** @type {?} */
            const parentRowIndex = parseInt(this.getClosestElemByTag(currentRowEl, 'igx-child-grid-row').parentNode.getAttribute('data-rowindex'), 10);
            /** @type {?} */
            const isLastRowInParent = parent.verticalScrollContainer.igxForOf.length - 1 === parentRowIndex;
            // check if next is sibling
            /** @type {?} */
            const childRowContainer = this.getChildGridRowContainer(this.grid);
            /** @type {?} */
            const nextIsSiblingChild = !!childRowContainer.nextElementSibling;
            if (isLastRowInParent && parentHasSummary && !nextIsSiblingChild) {
                // next is parent summary
                /** @type {?} */
                const parentSummary = parent.summariesRowList.toArray()[0].nativeElement;
                parent.navigation.focusNextRow(parentSummary, 0, this.grid.rootGrid, true);
            }
            else {
                // next is sibling or parent
                this.focusNext(0);
            }
        }
        else if (isLastDataRow && hasSummaries && isLastColumn && this.grid.parent) {
            // navigating in child rows, next is child grid's summary row
            this.focusNextRow(summaryRows[0].nativeElement, 0, this.grid.parent, true);
        }
        else {
            super.performTab(currentRowEl, selectedNode);
        }
    }
    /**
     * @private
     * @param {?} currentRowEl
     * @param {?} grid
     * @return {?}
     */
    focusNextChildDOMElem(currentRowEl, grid) {
        /** @type {?} */
        const gridElem = currentRowEl.nextElementSibling.querySelector('igx-hierarchical-grid');
        /** @type {?} */
        const childGridID = gridElem.getAttribute('id');
        /** @type {?} */
        const childGrid = this.getChildGrid(childGridID, grid);
        if (childGrid.allowFiltering && childGrid.filterMode === FilterMode.quickFilter) {
            childGrid.navigation.moveFocusToFilterCell(true);
            return;
        }
        this.focusNextChild(currentRowEl.nextElementSibling, 0, grid);
    }
    /**
     * @param {?} column
     * @param {?} eventArgs
     * @return {?}
     */
    navigatePrevFilterCell(column, eventArgs) {
        if (column.visibleIndex === 0 && this.grid.parent) {
            eventArgs.preventDefault();
            /** @type {?} */
            let targetGrid = this.grid.parent;
            /** @type {?} */
            const prevSiblingChild = this.getChildGridRowContainer().previousElementSibling;
            if (prevSiblingChild) {
                /** @type {?} */
                const gridElem = prevSiblingChild.querySelectorAll('igx-hierarchical-grid')[0];
                targetGrid = this.getChildGrid(gridElem.getAttribute('id'), this.grid.parent);
            }
            this.focusPrev(targetGrid.unpinnedColumns[targetGrid.unpinnedColumns.length - 1].visibleIndex);
        }
        else {
            super.navigatePrevFilterCell(column, eventArgs);
        }
    }
    /**
     * @param {?} column
     * @param {?} eventArgs
     * @return {?}
     */
    navigateNextFilterCell(column, eventArgs) {
        /** @type {?} */
        const cols = this.grid.filteringService.unpinnedFilterableColumns;
        /** @type {?} */
        const nextFilterableIndex = cols.indexOf(column) + 1;
        if (nextFilterableIndex >= this.grid.filteringService.unpinnedFilterableColumns.length) {
            // next is not filter cell
            /** @type {?} */
            const dataRows = this.grid.rowList.toArray();
            /** @type {?} */
            const hasRows = dataRows.length !== 0;
            /** @type {?} */
            const summaryRows = this.grid.summariesRowList.toArray();
            /** @type {?} */
            const hasSummaries = summaryRows.length > 0 && summaryRows[0].summaryCells.length > 0;
            if (hasRows) {
                this.focusNextRow(dataRows[0].nativeElement, 0, this.grid, false);
            }
            else if (hasSummaries) {
                this.focusNextRow(summaryRows[0].nativeElement, 0, this.grid, true);
            }
            else {
                this.focusNext(0);
            }
            eventArgs.preventDefault();
        }
        else {
            super.navigateNextFilterCell(column, eventArgs);
        }
    }
    /**
     * @param {?} currentRowEl
     * @param {?} selectedNode
     * @return {?}
     */
    performShiftTabKey(currentRowEl, selectedNode) {
        /** @type {?} */
        const rowIndex = selectedNode.row;
        /** @type {?} */
        const visibleColumnIndex = selectedNode.column;
        /** @type {?} */
        const isSummary = selectedNode.isSummaryRow;
        if (visibleColumnIndex === 0 && rowIndex === 0 && this.grid.parent && !isSummary) {
            if (this.grid.allowFiltering && this.grid.filterMode === FilterMode.quickFilter) {
                this.moveFocusToFilterCell();
            }
            else {
                /** @type {?} */
                const prevSiblingChild = this.getChildGridRowContainer().previousElementSibling;
                if (prevSiblingChild) {
                    /** @type {?} */
                    const gridElem = prevSiblingChild.querySelectorAll('igx-hierarchical-grid')[0];
                    this.performShiftTabIntoChild(gridElem, currentRowEl, rowIndex);
                }
                else {
                    /** @type {?} */
                    const selNode = {
                        row: rowIndex,
                        column: this.grid.parent.unpinnedColumns[this.grid.parent.unpinnedColumns.length - 1].visibleIndex
                    };
                    this.navigateUp(currentRowEl, selNode);
                }
            }
        }
        else if (visibleColumnIndex === 0 && currentRowEl.previousElementSibling &&
            currentRowEl.previousElementSibling.children[0].tagName.toLowerCase() === 'igx-child-grid-row') {
            /** @type {?} */
            const gridElem = this.getLastGridElem(currentRowEl.previousElementSibling);
            this.performShiftTabIntoChild(gridElem, currentRowEl, rowIndex);
        }
        else if (visibleColumnIndex === 0 && isSummary) {
            /** @type {?} */
            const lastRowIndex = this.grid.verticalScrollContainer.igxForOf.length - 1;
            if (lastRowIndex === -1) {
                // no child data
                if (this.grid.allowFiltering && this.grid.filterMode === FilterMode.quickFilter) {
                    this.moveFocusToFilterCell();
                }
                else {
                    /** @type {?} */
                    const selNode = {
                        row: rowIndex,
                        column: this.grid.parent.unpinnedColumns[this.grid.parent.unpinnedColumns.length - 1].visibleIndex
                    };
                    this.navigateUp(currentRowEl, selNode);
                }
            }
            else if (!this.getIsChildAtIndex(lastRowIndex)) {
                super.goToLastCell();
            }
            else {
                /** @type {?} */
                const scrTopPosition = this.grid.verticalScrollContainer.getScrollForIndex(lastRowIndex, true);
                /** @type {?} */
                const verticalScroll = this.grid.verticalScrollContainer.getVerticalScroll();
                if (verticalScroll.scrollTop === scrTopPosition || isNaN(scrTopPosition)) {
                    /** @type {?} */
                    const closestChild = this.getLastGridElem(this.grid.getRowByIndex(lastRowIndex).nativeElement.parentElement);
                    this.performShiftTabIntoChild(closestChild, currentRowEl, rowIndex);
                }
                else {
                    this.scrollGrid(this.grid, scrTopPosition - verticalScroll.scrollTop, () => {
                        /** @type {?} */
                        const closestChild = this.getLastGridElem(this.grid.getRowByIndex(lastRowIndex).nativeElement.parentElement);
                        this.performShiftTabIntoChild(closestChild, currentRowEl, rowIndex);
                    });
                }
            }
        }
        else {
            super.performShiftTabKey(currentRowEl, selectedNode);
        }
    }
    /**
     * @private
     * @param {?} trContainer
     * @return {?}
     */
    getLastGridElem(trContainer) {
        /** @type {?} */
        const children = trContainer.children;
        /** @type {?} */
        const closestChild = children[children.length - 1].children[0].children[0];
        return closestChild;
    }
    /**
     * @private
     * @param {?} gridElem
     * @param {?} currentRowEl
     * @param {?} rowIndex
     * @return {?}
     */
    performShiftTabIntoChild(gridElem, currentRowEl, rowIndex) {
        /** @type {?} */
        const childGridID = gridElem.getAttribute('id');
        /** @type {?} */
        const childGrid = this.getChildGrid(childGridID, this.grid) || this.getChildGrid(childGridID, this.grid.parent);
        /** @type {?} */
        const lastIndex = childGrid.unpinnedColumns[childGrid.unpinnedColumns.length - 1].visibleIndex;
        /** @type {?} */
        const summaryRows = childGrid.summariesRowList.toArray();
        if (summaryRows.length > 0 && summaryRows[0].summaryCells.length > 0) {
            // move focus to last summary row cell
            /** @type {?} */
            const summaryRow = summaryRows[0].nativeElement;
            this.focusPrevRow(summaryRow, lastIndex, childGrid, true, true);
        }
        else if (childGrid.rowList.toArray().length === 0 &&
            childGrid.allowFiltering && childGrid.filterMode === FilterMode.quickFilter) {
            // move to filter cell
            childGrid.navigation.moveFocusToFilterCell();
        }
        else {
            // move to next cell
            this.navigateUp(currentRowEl, { row: rowIndex, column: lastIndex });
        }
    }
    /**
     * @private
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    _focusScrollCellInView(visibleColumnIndex) {
        /** @type {?} */
        const cellSelector = this.getCellSelector(visibleColumnIndex);
        /** @type {?} */
        const cells = this.grid.nativeElement.querySelectorAll(`${cellSelector}[data-visibleIndex="${visibleColumnIndex}"]`);
        /** @type {?} */
        const cell = cells[0];
        /** @type {?} */
        const childContainer = this.grid.nativeElement.parentNode.parentNode;
        /** @type {?} */
        const scrTop = this.grid.parent.verticalScrollContainer.getVerticalScroll().scrollTop;
        /** @type {?} */
        const dc = childContainer.parentNode.parentNode;
        /** @type {?} */
        const scrWith = parseInt(dc.style.top, 10);
        if (scrTop === 0 || scrWith === 0) {
            // cell is in view
            cell.focus({ preventScroll: true });
        }
        else {
            // scroll parent so that cell is in view
            this.scrollGrid(this.grid.parent, scrWith, () => cell.focus({ preventScroll: true }));
        }
    }
    /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @return {?}
     */
    focusNextChild(elem, visibleColumnIndex, grid) {
        /** @type {?} */
        const gridElem = elem.querySelector('igx-hierarchical-grid');
        /** @type {?} */
        const childGridID = gridElem.getAttribute('id');
        /** @type {?} */
        const childGrid = this.getChildGrid(childGridID, grid);
        if (childGrid.rowList.toArray().length === 0) {
            this.focusNext(visibleColumnIndex, childGrid);
            return;
        }
        // Update column index since the next child can have in general less columns than visibleColumnIndex value.
        /** @type {?} */
        const lastCellIndex = childGrid.unpinnedColumns[childGrid.unpinnedColumns.length - 1].visibleIndex;
        visibleColumnIndex = Math.min(lastCellIndex, visibleColumnIndex);
        if (childGrid.verticalScrollContainer.state.startIndex !== 0) {
            // scroll to top
            this.scrollGrid(childGrid, 'top', () => this.focusNextRow(elem, visibleColumnIndex, childGrid));
        }
        else {
            this.focusNextRow(elem, visibleColumnIndex, childGrid);
        }
    }
    /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @return {?}
     */
    focusPrevChild(elem, visibleColumnIndex, grid) {
        /** @type {?} */
        const grids = [];
        /** @type {?} */
        const gridElems = Array.from(elem.querySelectorAll('igx-hierarchical-grid'));
        /** @type {?} */
        const childLevel = grid.childLayoutList.first.level;
        gridElems.forEach((hg) => {
            /** @type {?} */
            const parentRow = this.getClosestElemByTag(hg, 'igx-child-grid-row');
            if (parentRow && parseInt(parentRow.getAttribute('data-level'), 10) === childLevel) {
                grids.push(hg);
            }
        });
        /** @type {?} */
        const gridElem = grids[grids.length - 1];
        /** @type {?} */
        const childGridID = gridElem.getAttribute('id');
        /** @type {?} */
        const childGrid = this.getChildGrid(childGridID, grid);
        if (childGrid.rowList.toArray().length === 0) {
            this.focusPrev(visibleColumnIndex, childGrid);
            return;
        }
        // Update column index since the previous child can have in general less columns than visibleColumnIndex value.
        /** @type {?} */
        const lastCellIndex = childGrid.unpinnedColumns[childGrid.unpinnedColumns.length - 1].visibleIndex;
        visibleColumnIndex = Math.min(lastCellIndex, visibleColumnIndex);
        /** @type {?} */
        const isScrolledToBottom = this._isScrolledToBottom(childGrid);
        /** @type {?} */
        const lastIndex = childGrid.verticalScrollContainer.igxForOf.length - 1;
        if (!isScrolledToBottom) {
            // scroll to end
            this.scrollGrid(childGrid, 'bottom', () => this.focusPrevChild(elem, visibleColumnIndex, grid));
        }
        else {
            /** @type {?} */
            const lastRowInChild = childGrid.getRowByIndex(lastIndex);
            /** @type {?} */
            const isChildGrid = lastRowInChild.nativeElement.nodeName.toLowerCase() === 'igx-child-grid-row';
            if (isChildGrid) {
                this.focusPrevChild(lastRowInChild.nativeElement.parentNode, visibleColumnIndex, childGrid);
            }
            else {
                this.focusPrevRow(lastRowInChild.nativeElement, visibleColumnIndex, childGrid, true);
            }
        }
    }
    /**
     * @private
     * @param {?} visibleColumnIndex
     * @param {?=} grid
     * @return {?}
     */
    focusPrev(visibleColumnIndex, grid) {
        /** @type {?} */
        const currGrid = grid || this.grid;
        /** @type {?} */
        let parentContainer = this.getChildContainer(currGrid);
        /** @type {?} */
        let childRowContainer = this.getChildGridRowContainer(currGrid);
        /** @type {?} */
        const prevIsSiblingChild = !!childRowContainer.previousElementSibling;
        /** @type {?} */
        let prev = childRowContainer.previousElementSibling || parentContainer.previousElementSibling;
        if (prev) {
            if (prevIsSiblingChild) {
                this.focusPrevChild(prev, visibleColumnIndex, currGrid.parent);
            }
            else {
                this.focusPrevRow(prev, visibleColumnIndex, currGrid.parent);
            }
        }
        else {
            this.scrollGrid(currGrid.parent, 'prev', () => {
                parentContainer = this.getChildContainer(grid);
                childRowContainer = this.getChildGridRowContainer(grid);
                prev = childRowContainer.previousElementSibling || parentContainer.previousElementSibling;
                if (prevIsSiblingChild) {
                    this.focusPrevChild(prev, visibleColumnIndex, currGrid.parent);
                }
                else {
                    this.focusPrevRow(prev, visibleColumnIndex, currGrid.parent);
                }
            });
        }
    }
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    getNextParentInfo(grid) {
        // find next parent that is not at bottom
        /** @type {?} */
        let currGrid = grid.parent;
        /** @type {?} */
        let nextElem = this.getChildContainer(grid).nextElementSibling;
        while (!nextElem && currGrid.parent !== null) {
            nextElem = this.getChildContainer(currGrid).nextElementSibling;
            currGrid = currGrid.parent;
        }
        return { grid: currGrid, nextElement: nextElem };
    }
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    getNextScrollable(grid) {
        /** @type {?} */
        let currGrid = grid.parent;
        if (!currGrid) {
            return { grid: grid, prev: null };
        }
        /** @type {?} */
        let nonScrollable = currGrid.verticalScrollContainer.getVerticalScroll().scrollTop === 0;
        /** @type {?} */
        let prev = grid;
        while (nonScrollable && currGrid.parent !== null) {
            prev = currGrid;
            currGrid = currGrid.parent;
            nonScrollable = currGrid.verticalScrollContainer.getVerticalScroll().scrollTop === 0;
        }
        return { grid: currGrid, prev: prev };
    }
    /**
     * @private
     * @param {?} visibleColumnIndex
     * @param {?=} grid
     * @return {?}
     */
    focusNext(visibleColumnIndex, grid) {
        /** @type {?} */
        const currGrid = grid || this.grid;
        /** @type {?} */
        const parentInfo = this.getNextParentInfo(currGrid);
        /** @type {?} */
        const nextParentGrid = parentInfo.grid;
        /** @type {?} */
        let nextParentElem = parentInfo.nextElement;
        /** @type {?} */
        let childRowContainer = this.getChildGridRowContainer(currGrid);
        /** @type {?} */
        const nextIsSiblingChild = !!childRowContainer.nextElementSibling;
        /** @type {?} */
        let next = childRowContainer.nextElementSibling || nextParentElem;
        /** @type {?} */
        const verticalScroll = nextParentGrid.verticalScrollContainer.getVerticalScroll();
        if (next) {
            if (nextIsSiblingChild) {
                this.focusNextChild(next, visibleColumnIndex, nextParentGrid);
            }
            else {
                this.focusNextRow(next, visibleColumnIndex, grid || nextParentGrid);
            }
        }
        else if (verticalScroll.scrollTop !==
            verticalScroll.scrollHeight - nextParentGrid.verticalScrollContainer.igxForContainerSize) {
            this.scrollGrid(nextParentGrid, 'next', () => {
                nextParentElem = parentInfo.nextElement;
                childRowContainer = this.getChildGridRowContainer();
                next = childRowContainer.nextElementSibling || nextParentElem;
                if (next && nextIsSiblingChild) {
                    this.focusNextChild(next, visibleColumnIndex, nextParentGrid);
                }
                else if (next) {
                    this.focusNextRow(next, visibleColumnIndex, grid || nextParentGrid);
                }
            });
        }
    }
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    getNextScrollableDown(grid) {
        /** @type {?} */
        let currGrid = grid.parent;
        if (!currGrid) {
            return { grid: grid, prev: null };
        }
        /** @type {?} */
        let scrollTop = currGrid.verticalScrollContainer.getVerticalScroll().scrollTop;
        /** @type {?} */
        let scrollHeight = currGrid.verticalScrollContainer.getVerticalScroll().scrollHeight;
        /** @type {?} */
        let nonScrollable = scrollHeight === 0 ||
            Math.round(scrollTop + currGrid.verticalScrollContainer.igxForContainerSize) === scrollHeight;
        /** @type {?} */
        let prev = grid;
        while (nonScrollable && currGrid.parent !== null) {
            prev = currGrid;
            currGrid = currGrid.parent;
            scrollTop = currGrid.verticalScrollContainer.getVerticalScroll().scrollTop;
            scrollHeight = currGrid.verticalScrollContainer.getVerticalScroll().scrollHeight;
            nonScrollable = scrollHeight === 0 ||
                Math.round(scrollTop + currGrid.verticalScrollContainer.igxForContainerSize) === scrollHeight;
        }
        return { grid: currGrid, prev: prev };
    }
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    _getMinBottom(grid) {
        /** @type {?} */
        let currGrid = grid;
        /** @type {?} */
        let bottom = currGrid.tbody.nativeElement.getBoundingClientRect().bottom;
        while (currGrid.parent) {
            currGrid = currGrid.parent;
            bottom = Math.min(bottom, currGrid.tbody.nativeElement.getBoundingClientRect().bottom);
        }
        return bottom;
    }
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    _getMaxTop(grid) {
        /** @type {?} */
        let currGrid = grid;
        /** @type {?} */
        let top = currGrid.tbody.nativeElement.getBoundingClientRect().top;
        while (currGrid.parent) {
            currGrid = currGrid.parent;
            top = Math.max(top, currGrid.tbody.nativeElement.getBoundingClientRect().top);
        }
        return top;
    }
    /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @param {?=} isSummary
     * @return {?}
     */
    focusNextRow(elem, visibleColumnIndex, grid, isSummary) {
        /** @type {?} */
        const cellSelector = this.getCellSelector(visibleColumnIndex, isSummary);
        if (grid.navigation.isColumnFullyVisible(visibleColumnIndex) && grid.navigation.isColumnLeftFullyVisible(visibleColumnIndex)) {
            /** @type {?} */
            const cell = elem.querySelector(`${cellSelector}[data-visibleIndex="${visibleColumnIndex}"]`);
            /** @type {?} */
            const closestScrollableGrid = this.getNextScrollableDown(grid).grid;
            // const diff = cell.getBoundingClientRect().bottom - grid.rootGrid.tbody.nativeElement.getBoundingClientRect().bottom;
            /** @type {?} */
            const gridBottom = this._getMinBottom(grid);
            /** @type {?} */
            const diff = cell.getBoundingClientRect().bottom - gridBottom;
            /** @type {?} */
            const inView = diff <= 0;
            /** @type {?} */
            const scrollTop = closestScrollableGrid.verticalScrollContainer.getVerticalScroll().scrollTop;
            /** @type {?} */
            const scrollHeight = closestScrollableGrid.verticalScrollContainer.getVerticalScroll().scrollHeight;
            /** @type {?} */
            const canScroll = !(scrollHeight === 0 ||
                Math.round(scrollTop + closestScrollableGrid.verticalScrollContainer.igxForContainerSize) === scrollHeight);
            if (!inView && canScroll) {
                this.scrollGrid(closestScrollableGrid, diff, () => cell.focus({ preventScroll: true }));
            }
            else {
                cell.focus({ preventScroll: true });
            }
        }
        else {
            /** @type {?} */
            const cellElem = elem.querySelector(`${cellSelector}`);
            /** @type {?} */
            const rowIndex = parseInt(cellElem.getAttribute('data-rowindex'), 10);
            grid.navigation.performHorizontalScrollToCell(rowIndex, visibleColumnIndex);
        }
    }
    /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @param {?=} inChild
     * @param {?=} isSummary
     * @return {?}
     */
    focusPrevRow(elem, visibleColumnIndex, grid, inChild, isSummary) {
        if (grid.navigation.isColumnFullyVisible(visibleColumnIndex) && grid.navigation.isColumnLeftFullyVisible(visibleColumnIndex)) {
            /** @type {?} */
            const cellSelector = this.getCellSelector(visibleColumnIndex, isSummary);
            /** @type {?} */
            const cells = elem.querySelectorAll(`${cellSelector}[data-visibleIndex="${visibleColumnIndex}"]`);
            /** @type {?} */
            let cell = cells[cells.length - 1];
            /** @type {?} */
            const rIndex = parseInt(elem.getAttribute('data-rowindex'), 10);
            /** @type {?} */
            const scrGrid = grid.verticalScrollContainer.getVerticalScroll().scrollTop !== 0 ? grid :
                this.getNextScrollable(grid).grid;
            /** @type {?} */
            const topGrid = scrGrid.tbody.nativeElement.getBoundingClientRect().top >
                grid.rootGrid.tbody.nativeElement.getBoundingClientRect().top ? scrGrid : grid.rootGrid;
            /** @type {?} */
            const gridTop = this._getMaxTop(grid);
            /** @type {?} */
            const scrTop = scrGrid.verticalScrollContainer.getVerticalScroll().scrollTop;
            /** @type {?} */
            const diff = cell.getBoundingClientRect().bottom -
                cell.offsetHeight - gridTop;
            if (scrTop !== 0 && diff < 0 && !inChild) {
                this.scrollGrid(scrGrid, diff, () => {
                    /** @type {?} */
                    const el = !isSummary ? grid.navigation.getRowByIndex(rIndex) : elem;
                    cell = el.querySelectorAll(`${cellSelector}[data-visibleIndex="${visibleColumnIndex}"]`)[0];
                    cell.focus({ preventScroll: true });
                });
            }
            else if (diff < 0 && inChild) {
                this.scrollGrid(topGrid, diff, () => {
                    cell.focus({ preventScroll: true });
                });
            }
            else {
                cell.focus({ preventScroll: true });
            }
        }
        else {
            this.horizontalScrollGridToIndex(grid, visibleColumnIndex, () => {
                this.focusPrevRow(elem, visibleColumnIndex, grid, inChild, isSummary);
            });
        }
    }
    /**
     * @private
     * @param {?} grid
     * @param {?} visibleColumnIndex
     * @param {?} callBackFunc
     * @return {?}
     */
    horizontalScrollGridToIndex(grid, visibleColumnIndex, callBackFunc) {
        /** @type {?} */
        const unpinnedIndex = this.getColumnUnpinnedIndex(visibleColumnIndex);
        grid.parentVirtDir.onChunkLoad
            .pipe(first())
            .subscribe(callBackFunc);
        grid.dataRowList.toArray()[0].virtDirRow.scrollTo(unpinnedIndex);
    }
    /**
     * @private
     * @param {?} grid
     * @param {?} target
     * @param {?} callBackFunc
     * @return {?}
     */
    scrollGrid(grid, target, callBackFunc) {
        grid.nativeElement.focus({ preventScroll: true });
        requestAnimationFrame(() => {
            if (typeof target === 'number') {
                grid.verticalScrollContainer.addScrollTop(target);
            }
            else {
                switch (target) {
                    case 'top':
                        grid.verticalScrollContainer.scrollTo(0);
                        break;
                    case 'bottom':
                        grid.verticalScrollContainer.scrollTo(grid.verticalScrollContainer.igxForOf.length - 1);
                        break;
                    case 'next':
                        grid.verticalScrollContainer.scrollNext();
                        break;
                    case 'prev':
                        grid.verticalScrollContainer.scrollPrev();
                        break;
                }
            }
            grid.verticalScrollContainer.onChunkLoad
                .pipe(first())
                .subscribe(callBackFunc);
        });
    }
    /**
     * @private
     * @param {?} rowElement
     * @param {?} currentRowIndex
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    _navigateUpInChild(rowElement, currentRowIndex, visibleColumnIndex) {
        /** @type {?} */
        const prevElem = rowElement.previousElementSibling;
        /** @type {?} */
        const scrollable = this.getNextScrollable(this.grid);
        /** @type {?} */
        const grid = scrollable.grid;
        /** @type {?} */
        const scrTop = grid.verticalScrollContainer.getVerticalScroll().scrollTop;
        /** @type {?} */
        const containerTop = scrollable.prev.nativeElement.parentNode.parentNode.parentNode.parentNode;
        /** @type {?} */
        const top = parseInt(containerTop.style.top, 10);
        if (scrTop !== 0 && top < 0) {
            this.scrollGrid(grid, -prevElem.offsetHeight, () => super.navigateUp(rowElement, { row: currentRowIndex, column: visibleColumnIndex }));
        }
        else {
            super.navigateUp(rowElement, { row: currentRowIndex, column: visibleColumnIndex });
        }
    }
    /**
     * @private
     * @param {?} rowElement
     * @param {?} currentRowIndex
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    _navigateDownInChild(rowElement, currentRowIndex, visibleColumnIndex) {
        /** @type {?} */
        const nextElem = rowElement.nextElementSibling;
        /** @type {?} */
        const childContainer = this.grid.nativeElement.parentNode.parentNode;
        /** @type {?} */
        const diff = childContainer.getBoundingClientRect().bottom - this.grid.rootGrid.nativeElement.getBoundingClientRect().bottom;
        /** @type {?} */
        const endIsVisible = diff < 0;
        /** @type {?} */
        const scrollable = this.getNextScrollableDown(this.grid);
        /** @type {?} */
        const grid = scrollable.grid;
        if (!endIsVisible) {
            this.scrollGrid(grid, nextElem.offsetHeight, () => super.navigateDown(rowElement, { row: currentRowIndex, column: visibleColumnIndex }));
        }
        else {
            super.navigateDown(rowElement, { row: currentRowIndex, column: visibleColumnIndex });
        }
    }
    /**
     * @private
     * @param {?} sourceElem
     * @param {?} targetTag
     * @return {?}
     */
    getClosestElemByTag(sourceElem, targetTag) {
        /** @type {?} */
        let result = sourceElem;
        while (result !== null && result.nodeType === 1) {
            if (result.tagName.toLowerCase() === targetTag.toLowerCase()) {
                return result;
            }
            result = result.parentNode;
        }
        return null;
    }
}
if (false) {
    /** @type {?} */
    IgxHierarchicalGridNavigationService.prototype.grid;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGllcmFyY2hpY2FsLWdyaWQtbmF2aWdhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vaWduaXRldWktYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9ncmlkcy9oaWVyYXJjaGljYWwtZ3JpZC9oaWVyYXJjaGljYWwtZ3JpZC1uYXZpZ2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRXRFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN2QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFJcEQsTUFBTSxPQUFPLG9DQUFxQyxTQUFRLHdCQUF3Qjs7Ozs7OztJQUdwRSxlQUFlLENBQUMsWUFBcUIsRUFBRSxTQUFTLEdBQUcsS0FBSztRQUM5RCxPQUFPLFNBQVMsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxDQUFDLDRCQUE0QixDQUFDO0lBQzlFLENBQUM7Ozs7O0lBRVMsY0FBYztRQUNwQixPQUFPLDJCQUEyQixDQUFDO0lBQ3ZDLENBQUM7Ozs7OztJQUVTLGFBQWEsQ0FBQyxLQUFLOztjQUNuQixRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRTs7Y0FDaEMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQzVELEdBQUcsUUFBUSxtQkFBbUIsS0FBSyxJQUFJLENBQUMsQ0FBQzs7WUFDekMsR0FBRztRQUNQLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTs7a0JBQ1QsVUFBVSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLEVBQUUsdUJBQXVCLENBQUM7WUFDdkUsSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxJ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dXJjZXNDb250ZW50IjpbImltcG9ydCB7IElneEdyaWROYXZpZ2F0aW9uU2VydmljZSB9IGZyb20gJy4uL2dyaWQtbmF2aWdhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IElneEhpZXJhcmNoaWNhbEdyaWRDb21wb25lbnQgfSBmcm9tICcuL2hpZXJhcmNoaWNhbC1ncmlkLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBmaXJzdCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZpbHRlck1vZGUgfSBmcm9tICcuLi9ncmlkLWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7IElneENvbHVtbkNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2dyaWRzL2NvbHVtbi5jb21wb25lbnQnO1xuaW1wb3J0IHsgSVNlbGVjdGlvbk5vZGUgfSBmcm9tICcuLi8uLi9jb3JlL2dyaWQtc2VsZWN0aW9uJztcblxuZXhwb3J0IGNsYXNzIElneEhpZXJhcmNoaWNhbEdyaWROYXZpZ2F0aW9uU2VydmljZSBleHRlbmRzIElneEdyaWROYXZpZ2F0aW9uU2VydmljZSB7XG4gICAgcHVibGljIGdyaWQ6IElneEhpZXJhcmNoaWNhbEdyaWRDb21wb25lbnQ7XG5cbiAgICBwcm90ZWN0ZWQgZ2V0Q2VsbFNlbGVjdG9yKHZpc2libGVJbmRleD86IG51bWJlciwgaXNTdW1tYXJ5ID0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuIGlzU3VtbWFyeSA/ICdpZ3gtZ3JpZC1zdW1tYXJ5LWNlbGwnIDogJ2lneC1oaWVyYXJjaGljYWwtZ3JpZC1jZWxsJztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0Um93U2VsZWN0b3IoKSB7XG4gICAgICAgIHJldHVybiAnaWd4LWhpZXJhcmNoaWNhbC1ncmlkLXJvdyc7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldFJvd0J5SW5kZXgoaW5kZXgpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSB0aGlzLmdldFJvd1NlbGVjdG9yKCk7XG4gICAgICAgIGNvbnN0IHJvd3MgPSBBcnJheS5mcm9tKHRoaXMuZ3JpZC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXG4gICAgICAgICAgICBgJHtzZWxlY3Rvcn1bZGF0YS1yb3dpbmRleD1cIiR7aW5kZXh9XCJdYCkpO1xuICAgICAgICBsZXQgcm93O1xuICAgICAgICByb3dzLmZvckVhY2goKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudEdyaWQgPSB0aGlzLmdldENsb3Nlc3RFbGVtQnlUYWcociwgJ2lneC1oaWVyYXJjaGljYWwtZ3JpZCcpO1xuICAgICAgICAgICAgaWYgKHBhcmVudEdyaWQgJiYgcGFyZW50R3JpZC5nZXRBdHRyaWJ1dGUoJ2lkJykgPT09IHRoaXMuZ3JpZC5pZCkge1xuICAgICAgICAgICAgICAgICAgICByb3cgPSByO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJvdztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENoaWxkQ29udGFpbmVyKGdyaWQ/KSB7XG4gICAgICAgIGNvbnN0IGN1cnJHcmlkID0gZ3JpZCB8fCB0aGlzLmdyaWQ7XG4gICAgICAgIHJldHVybiBjdXJyR3JpZC5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Q2hpbGRHcmlkUm93Q29udGFpbmVyKGdyaWQ/KSB7XG4gICAgICAgIGNvbnN0IGN1cnJHcmlkID0gZ3JpZCB8fCB0aGlzLmdyaWQ7XG4gICAgICAgIHJldHVybiBjdXJyR3JpZC5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENoaWxkR3JpZChjaGlsZEdyaWRJRCwgZ3JpZCkge1xuICAgICAgICBjb25zdCBjZ3JpZCA9IGdyaWQuaGdyaWRBUEkuZ2V0Q2hpbGRHcmlkcyh0cnVlKS5maWx0ZXIoKGcpID0+IGcuaWQgPT09IGNoaWxkR3JpZElEKVswXTtcbiAgICAgICAgcmV0dXJuIGNncmlkO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2lzU2Nyb2xsZWRUb0JvdHRvbShncmlkKSB7XG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcCA9IGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0VmVydGljYWxTY3JvbGwoKS5zY3JvbGxUb3A7XG4gICAgICAgIGNvbnN0IHNjcm9sbEhlaWdodCA9IGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0VmVydGljYWxTY3JvbGwoKS5zY3JvbGxIZWlnaHQ7XG4gICAgICAgIHJldHVybiBzY3JvbGxIZWlnaHQgPT09IDAgfHwgTWF0aC5yb3VuZChzY3JvbGxUb3AgKyAgZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JDb250YWluZXJTaXplKSA9PT0gc2Nyb2xsSGVpZ2h0O1xuICAgIH1cbiAgICBwcml2YXRlIGdldElzQ2hpbGRBdEluZGV4KGluZGV4KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdyaWQuaXNDaGlsZEdyaWRSZWNvcmQodGhpcy5ncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmlneEZvck9mW2luZGV4XSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENlbGxFbGVtZW50QnlWaXNpYmxlSW5kZXgocm93SW5kZXgsIHZpc2libGVDb2x1bW5JbmRleCwgaXNTdW1tYXJ5ID0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgY2VsbFNlbGVjdG9yID0gdGhpcy5nZXRDZWxsU2VsZWN0b3IodmlzaWJsZUNvbHVtbkluZGV4LCBpc1N1bW1hcnkpO1xuICAgICAgICBpZiAoaXNTdW1tYXJ5KSB7XG4gICAgICAgICAgICBjb25zdCBzdW1tYXJ5Um93ID0gIHRoaXMuZ3JpZC5zdW1tYXJpZXNSb3dMaXN0LnRvQXJyYXkoKVswXS5uYXRpdmVFbGVtZW50O1xuICAgICAgICAgICAgcmV0dXJuIHN1bW1hcnlSb3cucXVlcnlTZWxlY3RvcihcbiAgICAgICAgICAgICAgICBgJHtjZWxsU2VsZWN0b3J9W2RhdGEtdmlzaWJsZUluZGV4PVwiJHt2aXNpYmxlQ29sdW1uSW5kZXh9XCJdYCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgcm93ID0gdGhpcy5nZXRSb3dCeUluZGV4KHJvd0luZGV4KTtcbiAgICAgICAgcmV0dXJuIHJvdy5xdWVyeVNlbGVjdG9yKFxuICAgICAgICAgICAgYCR7Y2VsbFNlbGVjdG9yfVtkYXRhLXJvd2luZGV4PVwiJHtyb3dJbmRleH1cIl1bZGF0YS12aXNpYmxlSW5kZXg9XCIke3Zpc2libGVDb2x1bW5JbmRleH1cIl1gKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbmF2aWdhdGVVcChyb3dFbGVtZW50LCBzZWxlY3RlZE5vZGU6IElTZWxlY3Rpb25Ob2RlKSB7XG4gICAgICAgIGNvbnN0IHByZXZFbGVtID0gcm93RWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICBjb25zdCB2aXNpYmxlQ29sdW1uSW5kZXggPSBzZWxlY3RlZE5vZGUuY29sdW1uO1xuICAgICAgICBjb25zdCBjdXJyZW50Um93SW5kZXggPSBzZWxlY3RlZE5vZGUucm93O1xuICAgICAgICBpZiAocHJldkVsZW0pIHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVOYW1lID0gIHByZXZFbGVtLmNoaWxkcmVuWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICBjb25zdCBpc0VsZW1DaGlsZEdyaWQgPSAgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lneC1jaGlsZC1ncmlkLXJvdyc7XG4gICAgICAgICAgICBpZiAoaXNFbGVtQ2hpbGRHcmlkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c1ByZXZDaGlsZChwcmV2RWxlbSwgdmlzaWJsZUNvbHVtbkluZGV4LCB0aGlzLmdyaWQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5ncmlkLnBhcmVudCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBjdXJyZW50bHkgbmF2aWdhdGluZyBpbiBjaGlsZCBncmlkXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX25hdmlnYXRlVXBJbkNoaWxkKHJvd0VsZW1lbnQsIGN1cnJlbnRSb3dJbmRleCwgdmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzdXBlci5uYXZpZ2F0ZVVwKHJvd0VsZW1lbnQsIHNlbGVjdGVkTm9kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRSb3dJbmRleCAhPT0gMCkge1xuICAgICAgICAgICAgLy8gaGFuZGxlIHNjZW5hcmlvIHdoZW4gcHJldiBpdGVtIGlzIGNoaWxkIGdyaWQgYnV0IGlzIG5vdCB5ZXQgaW4gdmlld1xuICAgICAgICAgICAgY29uc3QgaXNQcmV2Q2hpbGRHcmlkID0gdGhpcy5nZXRJc0NoaWxkQXRJbmRleChjdXJyZW50Um93SW5kZXggLSAxKTtcbiAgICAgICAgICAgIGlmICghaXNQcmV2Q2hpbGRHcmlkKSB7XG4gICAgICAgICAgICAgICAgc3VwZXIubmF2aWdhdGVVcChyb3dFbGVtZW50LCBzZWxlY3RlZE5vZGUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLCAtcm93RWxlbWVudC5vZmZzZXRIZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd0VsZW1lbnQgPSB0aGlzLmdldFJvd0J5SW5kZXgoY3VycmVudFJvd0luZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmF2aWdhdGVVcChyb3dFbGVtZW50LCBzZWxlY3RlZE5vZGUpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmdyaWQucGFyZW50ICE9PSBudWxsICYmXG4gICAgICAgICAgICBjdXJyZW50Um93SW5kZXggPT09IDApIHtcbiAgICAgICAgICAgICAgICAvLyBtb3ZlIHRvIHByZXYgcm93IGluIHNpYmxpbmcgbGF5b3V0IG9yIHBhcmVudFxuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNQcmV2KHZpc2libGVDb2x1bW5JbmRleCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIG5hdmlnYXRlRG93bihyb3dFbGVtZW50LCBzZWxlY3RlZE5vZGU6IElTZWxlY3Rpb25Ob2RlKSB7XG4gICAgICAgIGNvbnN0IG5leHRFbGVtID0gcm93RWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGNvbnN0IHZpc2libGVDb2x1bW5JbmRleCA9IHNlbGVjdGVkTm9kZS5jb2x1bW47XG4gICAgICAgIGNvbnN0IGN1cnJlbnRSb3dJbmRleCA9IHNlbGVjdGVkTm9kZS5yb3c7XG4gICAgICAgIGlmIChuZXh0RWxlbSkge1xuICAgICAgICAgICAgLy8gbmV4dCBlbGVtIGlzIGluIERPTVxuICAgICAgICAgICAgY29uc3Qgbm9kZU5hbWUgPSAgbmV4dEVsZW0uY2hpbGRyZW5bMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIGNvbnN0IGlzTmV4dEVsZW1DaGlsZEdyaWQgPSAgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lneC1jaGlsZC1ncmlkLXJvdyc7XG4gICAgICAgICAgICBpZiAoaXNOZXh0RWxlbUNoaWxkR3JpZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0Q2hpbGQobmV4dEVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgdGhpcy5ncmlkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZ3JpZC5wYXJlbnQgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudGx5IG5hdmlnYXRpbmcgaW4gY2hpbGQgZ3JpZFxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9uYXZpZ2F0ZURvd25JbkNoaWxkKHJvd0VsZW1lbnQsIGN1cnJlbnRSb3dJbmRleCwgdmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzdXBlci5uYXZpZ2F0ZURvd24ocm93RWxlbWVudCwgc2VsZWN0ZWROb2RlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFJvd0luZGV4ICE9PSB0aGlzLmdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuaWd4Rm9yT2YubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgIC8vIHNjcm9sbCBuZXh0IGluIHZpZXdcbiAgICAgICAgICAgICBzdXBlci5uYXZpZ2F0ZURvd24ocm93RWxlbWVudCwgc2VsZWN0ZWROb2RlKTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmdyaWQucGFyZW50ICE9PSBudWxsICYmXG4gICAgICAgICAgICBjdXJyZW50Um93SW5kZXggPT09IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JPZi5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgLy8gbW92ZSB0byBuZXh0IHJvdyBpbiBzaWJsaW5nIGxheW91dCBvciBpbiBwYXJlbnRcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dCh2aXNpYmxlQ29sdW1uSW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIG5hdmlnYXRlVG9wKHZpc2libGVDb2x1bW5JbmRleCkge1xuICAgICAgICBpZiAodGhpcy5ncmlkLnBhcmVudCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gbmF2aWdhdGluZyBpbiBjaGlsZFxuICAgICAgICAgICAgY29uc3QgdmVydGljYWxTY3JvbGwgPSB0aGlzLmdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0VmVydGljYWxTY3JvbGwoKTtcbiAgICAgICAgICAgIGNvbnN0IGNlbGxTZWxlY3RvciA9IHRoaXMuZ2V0Q2VsbFNlbGVjdG9yKHZpc2libGVDb2x1bW5JbmRleCk7XG5cbiAgICAgICAgICAgIGlmICh2ZXJ0aWNhbFNjcm9sbC5zY3JvbGxUb3AgPT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9mb2N1c1Njcm9sbENlbGxJblZpZXcodmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKHRoaXMuZ3JpZCwgJ3RvcCcsXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjZWxscyA9IHRoaXMuZ3JpZC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtjZWxsU2VsZWN0b3J9W2RhdGEtdmlzaWJsZUluZGV4PVwiJHt2aXNpYmxlQ29sdW1uSW5kZXh9XCJdYCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjZWxscy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9mb2N1c1Njcm9sbENlbGxJblZpZXcodmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VwZXIubmF2aWdhdGVUb3AodmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBuYXZpZ2F0ZUJvdHRvbSh2aXNpYmxlQ29sdW1uSW5kZXgpIHtcbiAgICAgICAgLy8gaGFuZGxlIHNjZW5hcmlvIHdoZXJlIGxhc3QgaW5kZXggaXMgY2hpbGQgZ3JpZFxuICAgICAgICAvLyBpbiB0aGF0IGNhc2UgZm9jdXMgY2VsbCBpbiBsYXN0IGRhdGEgcm93XG4gICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JPZi5sZW5ndGggLSAxO1xuICAgICAgICBpZiAodGhpcy5nZXRJc0NoaWxkQXRJbmRleChsYXN0SW5kZXgpKSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRJbmRleCA9IGxhc3RJbmRleCAtIDE7XG4gICAgICAgICAgICBjb25zdCBzY3JUb3BQb3NpdGlvbiA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRTY3JvbGxGb3JJbmRleCh0YXJnZXRJbmRleCwgdHJ1ZSk7XG4gICAgICAgICAgICBjb25zdCB2ZXJ0aWNhbFNjcm9sbCA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRWZXJ0aWNhbFNjcm9sbCgpO1xuICAgICAgICAgICAgY29uc3QgY2VsbFNlbGVjdG9yID0gdGhpcy5nZXRDZWxsU2VsZWN0b3IodmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgICAgIGlmICh2ZXJ0aWNhbFNjcm9sbC5zY3JvbGxUb3AgPT09IHNjclRvcFBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2VsbHMgPSB0aGlzLmdldFJvd0J5SW5kZXgodGFyZ2V0SW5kZXgpLnF1ZXJ5U2VsZWN0b3JBbGwoXG4gICAgICAgICAgICAgICAgICAgIGAke2NlbGxTZWxlY3Rvcn1bZGF0YS12aXNpYmxlSW5kZXg9XCIke3Zpc2libGVDb2x1bW5JbmRleH1cIl1gKTtcbiAgICAgICAgICAgICAgICBjZWxsc1tjZWxscy5sZW5ndGggLSAxXS5mb2N1cygpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLCBzY3JUb3BQb3NpdGlvbiAtIHZlcnRpY2FsU2Nyb2xsLnNjcm9sbFRvcCxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlbGxzID0gdGhpcy5nZXRSb3dCeUluZGV4KHRhcmdldEluZGV4KS5xdWVyeVNlbGVjdG9yQWxsKFxuICAgICAgICAgICAgICAgICAgICAgICAgYCR7Y2VsbFNlbGVjdG9yfVtkYXRhLXZpc2libGVJbmRleD1cIiR7dmlzaWJsZUNvbHVtbkluZGV4fVwiXWApO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2VsbHMubGVuZ3RoID4gMCkgeyBjZWxsc1tjZWxscy5sZW5ndGggLSAxXS5mb2N1cygpOyB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdXBlci5uYXZpZ2F0ZUJvdHRvbSh2aXNpYmxlQ29sdW1uSW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBnb1RvTGFzdENlbGwoKSB7XG4gICAgICAgIC8vIGhhbmRsZSBzY2VuYXJpbyB3aGVyZSBsYXN0IGluZGV4IGlzIGNoaWxkIGdyaWRcbiAgICAgICAgLy8gaW4gdGhhdCBjYXNlIGZvY3VzIGxhc3QgY2VsbCBpbiBsYXN0IGRhdGEgcm93XG4gICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JPZi5sZW5ndGggLSAxO1xuICAgICAgICBpZiAodGhpcy5nZXRJc0NoaWxkQXRJbmRleChsYXN0SW5kZXgpKSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRJbmRleCA9IGxhc3RJbmRleCAtIDE7XG4gICAgICAgICAgICBjb25zdCBzY3JUb3BQb3NpdGlvbiA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRTY3JvbGxGb3JJbmRleCh0YXJnZXRJbmRleCwgdHJ1ZSk7XG4gICAgICAgICAgICBjb25zdCB2ZXJ0aWNhbFNjcm9sbCA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRWZXJ0aWNhbFNjcm9sbCgpO1xuICAgICAgICAgICAgaWYgKHZlcnRpY2FsU2Nyb2xsLnNjcm9sbFRvcCA9PT0gc2NyVG9wUG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uS2V5ZG93bkVuZCh0YXJnZXRJbmRleCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZCh0aGlzLmdyaWQsIHNjclRvcFBvc2l0aW9uIC0gdmVydGljYWxTY3JvbGwuc2Nyb2xsVG9wLFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uS2V5ZG93bkVuZCh0YXJnZXRJbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VwZXIuZ29Ub0xhc3RDZWxsKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgb25LZXlkb3duRW5kKHJvd0luZGV4LCBpc1N1bW1hcnkgPSBmYWxzZSkge1xuICAgICAgICBpZiAodGhpcy5ncmlkLnBhcmVudCAmJiAhaXNTdW1tYXJ5KSB7XG4gICAgICAgICAgICAvLyBoYW5kbGUgc2NlbmFyaW8gd2hlcmUgbGFzdCBjaGlsZCByb3cgbWlnaHQgbm90IGJlIGluIHZpZXdcbiAgICAgICAgICAgIC8vIHBhcmVudCBzaG91bGQgc2Nyb2xsIHRvIGNoaWxkIGdyaWQgZW5kXG4gICAgICAgICAgICBjb25zdCBjaGlsZENvbnRhaW5lciA9IHRoaXMuZ3JpZC5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZTtcbiAgICAgICAgICAgIGNvbnN0IGRpZmZCb3R0b20gPVxuICAgICAgICAgICAgY2hpbGRDb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tIC0gdGhpcy5ncmlkLnJvb3RHcmlkLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xuICAgICAgICAgICAgY29uc3Qgcm93ID0gdGhpcy5ncmlkLmdldFJvd0J5SW5kZXgocm93SW5kZXgpLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICAgICAgICAgIGNvbnN0IHJvd0JvdHRvbSA9IHJvdy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207XG4gICAgICAgICAgICBjb25zdCByb3dJc1Zpc2libGUgPSByb3dCb3R0b20gPD0gdGhpcy5ncmlkLnJvb3RHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xuICAgICAgICAgICAgY29uc3QgZ3JpZFRvcCA9IHRoaXMuX2dldE1heFRvcCh0aGlzLmdyaWQpO1xuICAgICAgICAgICAgY29uc3QgZGlmZlRvcCA9IHJvdy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b20gLVxuICAgICAgICAgICAgcm93Lm9mZnNldEhlaWdodCAtIGdyaWRUb3A7XG4gICAgICAgICAgICBjb25zdCBlbmRJc1Zpc2libGUgPSBkaWZmQm90dG9tIDw9IDA7XG4gICAgICAgICAgICBjb25zdCB0b3BWaXNpYmxlID0gZGlmZlRvcCA+PSAwO1xuICAgICAgICAgICAgaWYgKCFlbmRJc1Zpc2libGUgJiYgIXJvd0lzVmlzaWJsZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZCh0aGlzLmdyaWQucGFyZW50LCBkaWZmQm90dG9tLCAoKSA9PiBzdXBlci5vbktleWRvd25FbmQocm93SW5kZXgpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRvcFZpc2libGUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzY3JHcmlkID0gdGhpcy5ncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFZlcnRpY2FsU2Nyb2xsKCkuc2Nyb2xsVG9wICE9PSAwID8gdGhpcy5ncmlkIDpcbiAgICAgICAgICAgICAgICB0aGlzLmdldE5leHRTY3JvbGxhYmxlKHRoaXMuZ3JpZCkuZ3JpZDtcbiAgICAgICAgICAgICAgICBjb25zdCB0b3BHcmlkID0gc2NyR3JpZC50Ym9keS5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCA+XG4gICAgICAgICAgICAgICAgdGhpcy5ncmlkLnJvb3RHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wID8gc2NyR3JpZCA6IHRoaXMuZ3JpZC5yb290R3JpZDtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodG9wR3JpZCwgZGlmZlRvcCwgKCkgPT4gc3VwZXIub25LZXlkb3duRW5kKHJvd0luZGV4KSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN1cGVyLm9uS2V5ZG93bkVuZChyb3dJbmRleCwgaXNTdW1tYXJ5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLm9uS2V5ZG93bkVuZChyb3dJbmRleCwgaXNTdW1tYXJ5KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIGdvVG9GaXJzdENlbGwoKSB7XG4gICAgICAgIGNvbnN0IHZlcnRpY2FsU2Nyb2xsID0gdGhpcy5ncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFZlcnRpY2FsU2Nyb2xsKCk7XG4gICAgICAgIGNvbnN0IGhvcml6b250YWxTY3JvbGwgPSB0aGlzLmdyaWQuZGF0YVJvd0xpc3QuZmlyc3QudmlydERpclJvdy5nZXRIb3Jpem9udGFsU2Nyb2xsKCk7XG4gICAgICAgIGlmICh2ZXJ0aWNhbFNjcm9sbC5zY3JvbGxUb3AgPT09IDAgJiYgdGhpcy5ncmlkLnBhcmVudCkge1xuICAgICAgICAgICAgLy8gc2Nyb2xsIHBhcmVudCBzbyB0aGF0IGN1cnJlbnQgY2hpbGQgaXMgaW4gdmlld1xuICAgICAgICAgICAgaWYgKCFob3Jpem9udGFsU2Nyb2xsLmNsaWVudFdpZHRoIHx8IHBhcnNlSW50KGhvcml6b250YWxTY3JvbGwuc2Nyb2xsTGVmdCwgMTApIDw9IDEgfHwgdGhpcy5ncmlkLnBpbm5lZENvbHVtbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZVRvcCgwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ob3Jpem9udGFsU2Nyb2xsKHRoaXMuZ3JpZC5kYXRhUm93TGlzdC5maXJzdC5pbmRleCkuc2Nyb2xsVG8oMCk7XG4gICAgICAgICAgICAgICAgdGhpcy5ncmlkLnBhcmVudFZpcnREaXIub25DaHVua0xvYWRcbiAgICAgICAgICAgICAgICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hdmlnYXRlVG9wKDApO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLmdvVG9GaXJzdENlbGwoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBwZXJmb3JtVGFiKGN1cnJlbnRSb3dFbCwgc2VsZWN0ZWROb2RlOiBJU2VsZWN0aW9uTm9kZSkge1xuICAgICAgICBjb25zdCByb3dJbmRleCA9IHNlbGVjdGVkTm9kZS5yb3c7XG4gICAgICAgIGNvbnN0IHZpc2libGVDb2x1bW5JbmRleCA9IHNlbGVjdGVkTm9kZS5jb2x1bW47XG4gICAgICAgIGNvbnN0IGlzU3VtbWFyeVJvdyA9IHNlbGVjdGVkTm9kZS5pc1N1bW1hcnlSb3c7XG4gICAgICAgIGNvbnN0IHN1bW1hcnlSb3dzID0gdGhpcy5ncmlkLnN1bW1hcmllc1Jvd0xpc3QudG9BcnJheSgpO1xuICAgICAgICBjb25zdCBoYXNTdW1tYXJpZXMgPSBzdW1tYXJ5Um93cy5sZW5ndGggPiAwO1xuICAgICAgICBjb25zdCBpc0xhc3REYXRhUm93ID0gcm93SW5kZXggPT09IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JPZi5sZW5ndGggLSAxO1xuICAgICAgICBjb25zdCBuZXh0SXNEYXRhUm93ID0gdGhpcy5ncmlkLmRhdGFSb3dMaXN0LmZpbmQocm93ID0+IHJvdy5pbmRleCA9PT0gcm93SW5kZXggKyAxKSA7XG4gICAgICAgIGNvbnN0IGlzTGFzdENvbHVtbiA9ICB0aGlzLmdyaWQudW5waW5uZWRDb2x1bW5zW3RoaXMuZ3JpZC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4ID09PSB2aXNpYmxlQ29sdW1uSW5kZXg7XG4gICAgICAgIGNvbnN0IGlzTGFzdFN1bW1hcnlSb3cgPSBoYXNTdW1tYXJpZXMgJiYgaXNTdW1tYXJ5Um93O1xuICAgICAgICBjb25zdCBuZXh0SW5kZXggPSByb3dJbmRleCArIDE7XG4gICAgICAgIGNvbnN0IHZpcnQgPSB0aGlzLmdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXI7XG4gICAgICAgIGNvbnN0IGlzTmV4dENoaWxkID0gbmV4dEluZGV4IDw9IHZpcnQuaWd4Rm9yT2YubGVuZ3RoIC0gMSAmJlxuICAgICAgICAgICAgdGhpcy5ncmlkLmlzQ2hpbGRHcmlkUmVjb3JkKHZpcnQuaWd4Rm9yT2ZbbmV4dEluZGV4XSk7XG4gICAgICAgIGlmICghbmV4dElzRGF0YVJvdyAmJiAhKGlzTGFzdERhdGFSb3cgJiYgaGFzU3VtbWFyaWVzKSAmJiBpc0xhc3RDb2x1bW4gJiYgIWlzU3VtbWFyeVJvdykge1xuICAgICAgICAgICAgLy8gbmF2aWdhdGluZyBpbiBjaGlsZCwgbmV4dCBpcyBub3Qgc3VtbWFyeVxuICAgICAgICAgICAgY29uc3QgY2hpbGRDb250YWluZXIgPSB0aGlzLmdldENoaWxkR3JpZFJvd0NvbnRhaW5lcigpO1xuICAgICAgICAgICAgY29uc3QgbmV4dElzU2libGluZ0NoaWxkID0gdGhpcy5ncmlkLnBhcmVudCA/ICEhY2hpbGRDb250YWluZXIubmV4dEVsZW1lbnRTaWJsaW5nIDogZmFsc2U7XG4gICAgICAgICAgICBpZiAobmV4dElzU2libGluZ0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c05leHRDaGlsZERPTUVsZW0oY2hpbGRDb250YWluZXIsIHRoaXMuZ3JpZC5wYXJlbnQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChpc05leHRDaGlsZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzSW5WaWV3ID0gdmlydC5zdGF0ZS5zdGFydEluZGV4ICsgdmlydC5zdGF0ZS5jaHVua1NpemUgPiBuZXh0SW5kZXg7XG4gICAgICAgICAgICAgICAgaWYgKCFpc0luVmlldykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLCAnbmV4dCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0Q2hpbGRET01FbGVtKGN1cnJlbnRSb3dFbCwgdGhpcy5ncmlkKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb2N1c05leHRDaGlsZERPTUVsZW0oY3VycmVudFJvd0VsLCB0aGlzLmdyaWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZURvd24oY3VycmVudFJvd0VsLCB7IHJvdzogIHJvd0luZGV4LCBjb2x1bW46IDB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChpc0xhc3RTdW1tYXJ5Um93ICYmIGlzTGFzdENvbHVtbiAmJiB0aGlzLmdyaWQucGFyZW50KSB7XG4gICAgICAgICAgICAvLyBuYXZpZ2F0aW5nIGluIGNoaWxkIHN1bW1hcnksIG5leHQgaXMgcGFyZW50IHN1bW1hcnkgb3IgbmV4dCBwYXJlbnQgcm93XG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmdyaWQucGFyZW50O1xuICAgICAgICAgICAgY29uc3QgcGFyZW50SGFzU3VtbWFyeSA9IHBhcmVudC5zdW1tYXJpZXNSb3dMaXN0LnRvQXJyYXkoKS5sZW5ndGggPiAwO1xuICAgICAgICAgICAgY29uc3QgcGFyZW50Um93SW5kZXggPSBwYXJzZUludChcbiAgICAgICAgICAgICAgICB0aGlzLmdldENsb3Nlc3RFbGVtQnlUYWcoY3VycmVudFJvd0VsLCAnaWd4LWNoaWxkLWdyaWQtcm93JykucGFyZW50Tm9kZS5nZXRBdHRyaWJ1dGUoJ2RhdGEtcm93aW5kZXgnKSwgMTApO1xuICAgICAgICAgICAgY29uc3QgaXNMYXN0Um93SW5QYXJlbnQgPSBwYXJlbnQudmVydGljYWxTY3JvbGxDb250YWluZXIuaWd4Rm9yT2YubGVuZ3RoIC0gMSA9PT0gcGFyZW50Um93SW5kZXg7XG4gICAgICAgICAgICAvLyBjaGVjayBpZiBuZXh0IGlzIHNpYmxpbmdcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkUm93Q29udGFpbmVyID0gdGhpcy5nZXRDaGlsZEdyaWRSb3dDb250YWluZXIodGhpcy5ncmlkKTtcbiAgICAgICAgICAgIGNvbnN0IG5leHRJc1NpYmxpbmdDaGlsZCA9ICEhY2hpbGRSb3dDb250YWluZXIubmV4dEVsZW1lbnRTaWJsaW5nO1xuICAgICAgICAgICAgaWYgKGlzTGFzdFJvd0luUGFyZW50ICYmIHBhcmVudEhhc1N1bW1hcnkgJiYgIW5leHRJc1NpYmxpbmdDaGlsZCkge1xuICAgICAgICAgICAgICAgIC8vIG5leHQgaXMgcGFyZW50IHN1bW1hcnlcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnRTdW1tYXJ5ID0gcGFyZW50LnN1bW1hcmllc1Jvd0xpc3QudG9BcnJheSgpWzBdLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgICAgICAgICAgcGFyZW50Lm5hdmlnYXRpb24uZm9jdXNOZXh0Um93KHBhcmVudFN1bW1hcnksIDAsIHRoaXMuZ3JpZC5yb290R3JpZCwgdHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIG5leHQgaXMgc2libGluZyBvciBwYXJlbnRcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dCgwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlICBpZiAoaXNMYXN0RGF0YVJvdyAmJiBoYXNTdW1tYXJpZXMgJiYgaXNMYXN0Q29sdW1uICYmIHRoaXMuZ3JpZC5wYXJlbnQpIHtcbiAgICAgICAgICAgIC8vIG5hdmlnYXRpbmcgaW4gY2hpbGQgcm93cywgbmV4dCBpcyBjaGlsZCBncmlkJ3Mgc3VtbWFyeSByb3dcbiAgICAgICAgICAgdGhpcy5mb2N1c05leHRSb3coc3VtbWFyeVJvd3NbMF0ubmF0aXZlRWxlbWVudCwgMCwgdGhpcy5ncmlkLnBhcmVudCwgdHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdXBlci5wZXJmb3JtVGFiKGN1cnJlbnRSb3dFbCwgc2VsZWN0ZWROb2RlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZm9jdXNOZXh0Q2hpbGRET01FbGVtKGN1cnJlbnRSb3dFbCwgZ3JpZCkge1xuICAgICAgICBjb25zdCBncmlkRWxlbSA9IGN1cnJlbnRSb3dFbC5uZXh0RWxlbWVudFNpYmxpbmcucXVlcnlTZWxlY3RvcignaWd4LWhpZXJhcmNoaWNhbC1ncmlkJyk7XG4gICAgICAgIGNvbnN0IGNoaWxkR3JpZElEID0gZ3JpZEVsZW0uZ2V0QXR0cmlidXRlKCdpZCcpO1xuICAgICAgICBjb25zdCBjaGlsZEdyaWQgPSB0aGlzLmdldENoaWxkR3JpZChjaGlsZEdyaWRJRCwgZ3JpZCk7XG4gICAgICAgIGlmIChjaGlsZEdyaWQuYWxsb3dGaWx0ZXJpbmcgJiYgY2hpbGRHcmlkLmZpbHRlck1vZGUgPT09IEZpbHRlck1vZGUucXVpY2tGaWx0ZXIpIHtcbiAgICAgICAgICAgIGNoaWxkR3JpZC5uYXZpZ2F0aW9uLm1vdmVGb2N1c1RvRmlsdGVyQ2VsbCh0cnVlKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmZvY3VzTmV4dENoaWxkKGN1cnJlbnRSb3dFbC5uZXh0RWxlbWVudFNpYmxpbmcsIDAsIGdyaWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBuYXZpZ2F0ZVByZXZGaWx0ZXJDZWxsKGNvbHVtbjogSWd4Q29sdW1uQ29tcG9uZW50LCBldmVudEFyZ3MpIHtcbiAgICAgICAgaWYgKGNvbHVtbi52aXNpYmxlSW5kZXggPT09IDAgJiYgdGhpcy5ncmlkLnBhcmVudCkge1xuICAgICAgICAgICAgZXZlbnRBcmdzLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBsZXQgdGFyZ2V0R3JpZCA9IHRoaXMuZ3JpZC5wYXJlbnQ7XG4gICAgICAgICAgICBjb25zdCBwcmV2U2libGluZ0NoaWxkID0gdGhpcy5nZXRDaGlsZEdyaWRSb3dDb250YWluZXIoKS5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICAgICAgaWYgKHByZXZTaWJsaW5nQ2hpbGQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBncmlkRWxlbSA9IHByZXZTaWJsaW5nQ2hpbGQucXVlcnlTZWxlY3RvckFsbCgnaWd4LWhpZXJhcmNoaWNhbC1ncmlkJylbMF07XG4gICAgICAgICAgICAgICAgdGFyZ2V0R3JpZCA9IHRoaXMuZ2V0Q2hpbGRHcmlkKGdyaWRFbGVtLmdldEF0dHJpYnV0ZSgnaWQnKSwgdGhpcy5ncmlkLnBhcmVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmZvY3VzUHJldih0YXJnZXRHcmlkLnVucGlubmVkQ29sdW1uc1t0YXJnZXRHcmlkLnVucGlubmVkQ29sdW1ucy5sZW5ndGggLSAxXS52aXNpYmxlSW5kZXgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VwZXIubmF2aWdhdGVQcmV2RmlsdGVyQ2VsbChjb2x1bW4sIGV2ZW50QXJncyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgbmF2aWdhdGVOZXh0RmlsdGVyQ2VsbChjb2x1bW46IElneENvbHVtbkNvbXBvbmVudCwgZXZlbnRBcmdzKSB7XG4gICAgICAgIGNvbnN0IGNvbHMgPSB0aGlzLmdyaWQuZmlsdGVyaW5nU2VydmljZS51bnBpbm5lZEZpbHRlcmFibGVDb2x1bW5zO1xuICAgICAgICBjb25zdCBuZXh0RmlsdGVyYWJsZUluZGV4ID0gY29scy5pbmRleE9mKGNvbHVtbikgKyAxO1xuICAgICAgICBpZiAobmV4dEZpbHRlcmFibGVJbmRleCA+PSB0aGlzLmdyaWQuZmlsdGVyaW5nU2VydmljZS51bnBpbm5lZEZpbHRlcmFibGVDb2x1bW5zLmxlbmd0aCkge1xuICAgICAgICAgICAgLy8gbmV4dCBpcyBub3QgZmlsdGVyIGNlbGxcbiAgICAgICAgICAgIGNvbnN0IGRhdGFSb3dzID0gdGhpcy5ncmlkLnJvd0xpc3QudG9BcnJheSgpO1xuICAgICAgICAgICAgY29uc3QgaGFzUm93cyA9IGRhdGFSb3dzLmxlbmd0aCAhPT0gMDtcbiAgICAgICAgICAgIGNvbnN0IHN1bW1hcnlSb3dzID0gdGhpcy5ncmlkLnN1bW1hcmllc1Jvd0xpc3QudG9BcnJheSgpO1xuICAgICAgICAgICAgY29uc3QgaGFzU3VtbWFyaWVzID0gc3VtbWFyeVJvd3MubGVuZ3RoID4gMCAmJiBzdW1tYXJ5Um93c1swXS5zdW1tYXJ5Q2VsbHMubGVuZ3RoID4gMDtcbiAgICAgICAgICAgIGlmIChoYXNSb3dzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c05leHRSb3coZGF0YVJvd3NbMF0ubmF0aXZlRWxlbWVudCwgMCwgdGhpcy5ncmlkLCBmYWxzZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1N1bW1hcmllcykge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0Um93KHN1bW1hcnlSb3dzWzBdLm5hdGl2ZUVsZW1lbnQsIDAsIHRoaXMuZ3JpZCwgdHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0KDApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZXZlbnRBcmdzLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdXBlci5uYXZpZ2F0ZU5leHRGaWx0ZXJDZWxsKGNvbHVtbiwgZXZlbnRBcmdzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBwZXJmb3JtU2hpZnRUYWJLZXkoY3VycmVudFJvd0VsLCBzZWxlY3RlZE5vZGU6IElTZWxlY3Rpb25Ob2RlKSB7XG4gICAgICAgIGNvbnN0IHJvd0luZGV4ID0gc2VsZWN0ZWROb2RlLnJvdztcbiAgICAgICAgY29uc3QgdmlzaWJsZUNvbHVtbkluZGV4ID0gc2VsZWN0ZWROb2RlLmNvbHVtbjtcbiAgICAgICAgY29uc3QgaXNTdW1tYXJ5ID0gc2VsZWN0ZWROb2RlLmlzU3VtbWFyeVJvdztcbiAgICAgICAgaWYgKHZpc2libGVDb2x1bW5JbmRleCA9PT0gMCAmJiByb3dJbmRleCA9PT0gMCAmJiB0aGlzLmdyaWQucGFyZW50ICYmICFpc1N1bW1hcnkpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmdyaWQuYWxsb3dGaWx0ZXJpbmcgJiYgdGhpcy5ncmlkLmZpbHRlck1vZGUgPT09IEZpbHRlck1vZGUucXVpY2tGaWx0ZXIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vdmVGb2N1c1RvRmlsdGVyQ2VsbCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwcmV2U2libGluZ0NoaWxkID0gdGhpcy5nZXRDaGlsZEdyaWRSb3dDb250YWluZXIoKS5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICAgICAgICAgIGlmIChwcmV2U2libGluZ0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyaWRFbGVtID0gcHJldlNpYmxpbmdDaGlsZC5xdWVyeVNlbGVjdG9yQWxsKCdpZ3gtaGllcmFyY2hpY2FsLWdyaWQnKVswXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJmb3JtU2hpZnRUYWJJbnRvQ2hpbGQoZ3JpZEVsZW0sIGN1cnJlbnRSb3dFbCwgcm93SW5kZXgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlbE5vZGUgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3c6ICByb3dJbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbjogdGhpcy5ncmlkLnBhcmVudC51bnBpbm5lZENvbHVtbnNbdGhpcy5ncmlkLnBhcmVudC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmF2aWdhdGVVcChjdXJyZW50Um93RWwsIHNlbE5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh2aXNpYmxlQ29sdW1uSW5kZXggPT09IDAgJiYgY3VycmVudFJvd0VsLnByZXZpb3VzRWxlbWVudFNpYmxpbmcgJiZcbiAgICAgICAgICAgIGN1cnJlbnRSb3dFbC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nLmNoaWxkcmVuWzBdLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lneC1jaGlsZC1ncmlkLXJvdycpIHtcbiAgICAgICAgICAgIGNvbnN0IGdyaWRFbGVtID0gdGhpcy5nZXRMYXN0R3JpZEVsZW0oY3VycmVudFJvd0VsLnByZXZpb3VzRWxlbWVudFNpYmxpbmcpO1xuICAgICAgICAgICAgdGhpcy5wZXJmb3JtU2hpZnRUYWJJbnRvQ2hpbGQoZ3JpZEVsZW0sIGN1cnJlbnRSb3dFbCwgcm93SW5kZXgpO1xuICAgICAgICB9IGVsc2UgaWYgKHZpc2libGVDb2x1bW5JbmRleCA9PT0gMCAmJiBpc1N1bW1hcnkpIHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RSb3dJbmRleCA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JPZi5sZW5ndGggLSAxO1xuICAgICAgICAgICAgaWYgKGxhc3RSb3dJbmRleCA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvLyBubyBjaGlsZCBkYXRhXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZ3JpZC5hbGxvd0ZpbHRlcmluZyAmJiB0aGlzLmdyaWQuZmlsdGVyTW9kZSA9PT0gRmlsdGVyTW9kZS5xdWlja0ZpbHRlcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdmVGb2N1c1RvRmlsdGVyQ2VsbCgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlbE5vZGUgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3c6ICByb3dJbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbjogdGhpcy5ncmlkLnBhcmVudC51bnBpbm5lZENvbHVtbnNbdGhpcy5ncmlkLnBhcmVudC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmF2aWdhdGVVcChjdXJyZW50Um93RWwsIHNlbE5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuZ2V0SXNDaGlsZEF0SW5kZXgobGFzdFJvd0luZGV4KSkge1xuICAgICAgICAgICAgICAgIHN1cGVyLmdvVG9MYXN0Q2VsbCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzY3JUb3BQb3NpdGlvbiA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRTY3JvbGxGb3JJbmRleChsYXN0Um93SW5kZXgsIHRydWUpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHZlcnRpY2FsU2Nyb2xsID0gdGhpcy5ncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFZlcnRpY2FsU2Nyb2xsKCk7XG4gICAgICAgICAgICAgICAgaWYgKHZlcnRpY2FsU2Nyb2xsLnNjcm9sbFRvcCA9PT0gc2NyVG9wUG9zaXRpb24gfHwgaXNOYU4oc2NyVG9wUG9zaXRpb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsb3Nlc3RDaGlsZCA9IHRoaXMuZ2V0TGFzdEdyaWRFbGVtKHRoaXMuZ3JpZC5nZXRSb3dCeUluZGV4KGxhc3RSb3dJbmRleCkubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJmb3JtU2hpZnRUYWJJbnRvQ2hpbGQoY2xvc2VzdENoaWxkLCBjdXJyZW50Um93RWwsIHJvd0luZGV4KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLCBzY3JUb3BQb3NpdGlvbiAtIHZlcnRpY2FsU2Nyb2xsLnNjcm9sbFRvcCxcbiAgICAgICAgICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9zZXN0Q2hpbGQgPSB0aGlzLmdldExhc3RHcmlkRWxlbSh0aGlzLmdyaWQuZ2V0Um93QnlJbmRleChsYXN0Um93SW5kZXgpLm5hdGl2ZUVsZW1lbnQucGFyZW50RWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJmb3JtU2hpZnRUYWJJbnRvQ2hpbGQoY2xvc2VzdENoaWxkLCBjdXJyZW50Um93RWwsIHJvd0luZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLnBlcmZvcm1TaGlmdFRhYktleShjdXJyZW50Um93RWwsIHNlbGVjdGVkTm9kZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldExhc3RHcmlkRWxlbSh0ckNvbnRhaW5lcikge1xuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IHRyQ29udGFpbmVyLmNoaWxkcmVuO1xuICAgICAgICBjb25zdCBjbG9zZXN0Q2hpbGQgPSBjaGlsZHJlbltjaGlsZHJlbi5sZW5ndGggLSAxXS5jaGlsZHJlblswXS5jaGlsZHJlblswXTtcbiAgICAgICAgcmV0dXJuIGNsb3Nlc3RDaGlsZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBlcmZvcm1TaGlmdFRhYkludG9DaGlsZChncmlkRWxlbSwgY3VycmVudFJvd0VsLCByb3dJbmRleCkge1xuICAgICAgICBjb25zdCBjaGlsZEdyaWRJRCA9IGdyaWRFbGVtLmdldEF0dHJpYnV0ZSgnaWQnKTtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkR3JpZCA9IHRoaXMuZ2V0Q2hpbGRHcmlkKGNoaWxkR3JpZElELCB0aGlzLmdyaWQpIHx8IHRoaXMuZ2V0Q2hpbGRHcmlkKGNoaWxkR3JpZElELCB0aGlzLmdyaWQucGFyZW50KTtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IGNoaWxkR3JpZC51bnBpbm5lZENvbHVtbnNbY2hpbGRHcmlkLnVucGlubmVkQ29sdW1ucy5sZW5ndGggLSAxXS52aXNpYmxlSW5kZXg7XG4gICAgICAgICAgICBjb25zdCBzdW1tYXJ5Um93cyA9IGNoaWxkR3JpZC5zdW1tYXJpZXNSb3dMaXN0LnRvQXJyYXkoKTtcbiAgICAgICAgICAgIGlmIChzdW1tYXJ5Um93cy5sZW5ndGggPiAwICYmIHN1bW1hcnlSb3dzWzBdLnN1bW1hcnlDZWxscy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgLy8gbW92ZSBmb2N1cyB0byBsYXN0IHN1bW1hcnkgcm93IGNlbGxcbiAgICAgICAgICAgICAgICBjb25zdCBzdW1tYXJ5Um93ID0gc3VtbWFyeVJvd3NbMF0ubmF0aXZlRWxlbWVudDtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzUHJldlJvdyhzdW1tYXJ5Um93LCBsYXN0SW5kZXgsIGNoaWxkR3JpZCwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkR3JpZC5yb3dMaXN0LnRvQXJyYXkoKS5sZW5ndGggPT09IDAgJiZcbiAgICAgICAgICAgICBjaGlsZEdyaWQuYWxsb3dGaWx0ZXJpbmcgJiYgY2hpbGRHcmlkLmZpbHRlck1vZGUgPT09IEZpbHRlck1vZGUucXVpY2tGaWx0ZXIpIHtcbiAgICAgICAgICAgICAgICAgLy8gbW92ZSB0byBmaWx0ZXIgY2VsbFxuICAgICAgICAgICAgICAgIGNoaWxkR3JpZC5uYXZpZ2F0aW9uLm1vdmVGb2N1c1RvRmlsdGVyQ2VsbCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBtb3ZlIHRvIG5leHQgY2VsbFxuICAgICAgICAgICAgICAgIHRoaXMubmF2aWdhdGVVcChjdXJyZW50Um93RWwsIHsgcm93IDogcm93SW5kZXgsIGNvbHVtbjogbGFzdEluZGV4fSk7XG4gICAgICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZm9jdXNTY3JvbGxDZWxsSW5WaWV3KHZpc2libGVDb2x1bW5JbmRleCkge1xuICAgICAgICBjb25zdCBjZWxsU2VsZWN0b3IgPSB0aGlzLmdldENlbGxTZWxlY3Rvcih2aXNpYmxlQ29sdW1uSW5kZXgpO1xuICAgICAgICBjb25zdCBjZWxscyA9IHRoaXMuZ3JpZC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXG4gICAgICAgICAgICBgJHtjZWxsU2VsZWN0b3J9W2RhdGEtdmlzaWJsZUluZGV4PVwiJHt2aXNpYmxlQ29sdW1uSW5kZXh9XCJdYCk7XG4gICAgICAgIGNvbnN0IGNlbGwgPSBjZWxsc1swXTtcbiAgICAgICAgY29uc3QgY2hpbGRDb250YWluZXIgPSB0aGlzLmdyaWQubmF0aXZlRWxlbWVudC5wYXJlbnROb2RlLnBhcmVudE5vZGU7XG4gICAgICAgIGNvbnN0IHNjclRvcCA9IHRoaXMuZ3JpZC5wYXJlbnQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0VmVydGljYWxTY3JvbGwoKS5zY3JvbGxUb3A7XG4gICAgICAgIGNvbnN0IGRjID0gY2hpbGRDb250YWluZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xuICAgICAgICBjb25zdCBzY3JXaXRoID0gcGFyc2VJbnQoZGMuc3R5bGUudG9wLCAxMCk7XG4gICAgICAgIGlmIChzY3JUb3AgPT09IDAgfHwgc2NyV2l0aCA9PT0gMCkge1xuICAgICAgICAgICAgLy8gY2VsbCBpcyBpbiB2aWV3XG4gICAgICAgICAgICBjZWxsLmZvY3VzKHtwcmV2ZW50U2Nyb2xsOiB0cnVlfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBzY3JvbGwgcGFyZW50IHNvIHRoYXQgY2VsbCBpcyBpbiB2aWV3XG4gICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLnBhcmVudCwgc2NyV2l0aCAsICgpID0+IGNlbGwuZm9jdXMoe3ByZXZlbnRTY3JvbGw6IHRydWV9KSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGZvY3VzTmV4dENoaWxkKGVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgZ3JpZCkge1xuICAgICAgICBjb25zdCBncmlkRWxlbSA9IGVsZW0ucXVlcnlTZWxlY3RvcignaWd4LWhpZXJhcmNoaWNhbC1ncmlkJyk7XG4gICAgICAgIGNvbnN0IGNoaWxkR3JpZElEID0gZ3JpZEVsZW0uZ2V0QXR0cmlidXRlKCdpZCcpO1xuICAgICAgICBjb25zdCBjaGlsZEdyaWQgPSB0aGlzLmdldENoaWxkR3JpZChjaGlsZEdyaWRJRCwgZ3JpZCk7XG5cbiAgICAgICAgaWYgKGNoaWxkR3JpZC5yb3dMaXN0LnRvQXJyYXkoKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0KHZpc2libGVDb2x1bW5JbmRleCwgY2hpbGRHcmlkKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVwZGF0ZSBjb2x1bW4gaW5kZXggc2luY2UgdGhlIG5leHQgY2hpbGQgY2FuIGhhdmUgaW4gZ2VuZXJhbCBsZXNzIGNvbHVtbnMgdGhhbiB2aXNpYmxlQ29sdW1uSW5kZXggdmFsdWUuXG4gICAgICAgIGNvbnN0IGxhc3RDZWxsSW5kZXggPSBjaGlsZEdyaWQudW5waW5uZWRDb2x1bW5zW2NoaWxkR3JpZC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4O1xuICAgICAgICB2aXNpYmxlQ29sdW1uSW5kZXggPSBNYXRoLm1pbihsYXN0Q2VsbEluZGV4LCB2aXNpYmxlQ29sdW1uSW5kZXgpO1xuXG4gICAgICAgIGlmIChjaGlsZEdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc3RhdGUuc3RhcnRJbmRleCAhPT0gMCkge1xuICAgICAgICAgICAgLy8gc2Nyb2xsIHRvIHRvcFxuICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKGNoaWxkR3JpZCwgJ3RvcCcsICgpID0+IHRoaXMuZm9jdXNOZXh0Um93KGVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgY2hpbGRHcmlkKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmZvY3VzTmV4dFJvdyhlbGVtLCB2aXNpYmxlQ29sdW1uSW5kZXgsIGNoaWxkR3JpZCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBmb2N1c1ByZXZDaGlsZChlbGVtLCB2aXNpYmxlQ29sdW1uSW5kZXgsIGdyaWQpIHtcbiAgICAgICAgY29uc3QgZ3JpZHMgPSBbXTtcbiAgICAgICAgY29uc3QgZ3JpZEVsZW1zID0gQXJyYXkuZnJvbShlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lneC1oaWVyYXJjaGljYWwtZ3JpZCcpKTtcbiAgICAgICAgY29uc3QgY2hpbGRMZXZlbCA9IGdyaWQuY2hpbGRMYXlvdXRMaXN0LmZpcnN0LmxldmVsO1xuICAgICAgICBncmlkRWxlbXMuZm9yRWFjaCgoaGcpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudFJvdyA9IHRoaXMuZ2V0Q2xvc2VzdEVsZW1CeVRhZyhoZywgJ2lneC1jaGlsZC1ncmlkLXJvdycpO1xuICAgICAgICAgICAgaWYgKHBhcmVudFJvdyAmJiBwYXJzZUludChwYXJlbnRSb3cuZ2V0QXR0cmlidXRlKCdkYXRhLWxldmVsJyksIDEwKSA9PT0gY2hpbGRMZXZlbCkge1xuICAgICAgICAgICAgICAgIGdyaWRzLnB1c2goaGcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgZ3JpZEVsZW0gPSBncmlkc1tncmlkcy5sZW5ndGggLSAxXTtcbiAgICAgICAgY29uc3QgY2hpbGRHcmlkSUQgPSBncmlkRWxlbS5nZXRBdHRyaWJ1dGUoJ2lkJyk7XG4gICAgICAgIGNvbnN0IGNoaWxkR3JpZCA9IHRoaXMuZ2V0Q2hpbGRHcmlkKGNoaWxkR3JpZElELCBncmlkKTtcblxuICAgICAgICBpZiAoY2hpbGRHcmlkLnJvd0xpc3QudG9BcnJheSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5mb2N1c1ByZXYodmlzaWJsZUNvbHVtbkluZGV4LCBjaGlsZEdyaWQpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVXBkYXRlIGNvbHVtbiBpbmRleCBzaW5jZSB0aGUgcHJldmlvdXMgY2hpbGQgY2FuIGhhdmUgaW4gZ2VuZXJhbCBsZXNzIGNvbHVtbnMgdGhhbiB2aXNpYmxlQ29sdW1uSW5kZXggdmFsdWUuXG4gICAgICAgIGNvbnN0IGxhc3RDZWxsSW5kZXggPSBjaGlsZEdyaWQudW5waW5uZWRDb2x1bW5zW2NoaWxkR3JpZC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4O1xuICAgICAgICB2aXNpYmxlQ29sdW1uSW5kZXggPSBNYXRoLm1pbihsYXN0Q2VsbEluZGV4LCB2aXNpYmxlQ29sdW1uSW5kZXgpO1xuXG4gICAgICAgIGNvbnN0IGlzU2Nyb2xsZWRUb0JvdHRvbSA9IHRoaXMuX2lzU2Nyb2xsZWRUb0JvdHRvbShjaGlsZEdyaWQpO1xuICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBjaGlsZEdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuaWd4Rm9yT2YubGVuZ3RoIC0gMTtcbiAgICAgICAgaWYgKCFpc1Njcm9sbGVkVG9Cb3R0b20pIHtcbiAgICAgICAgICAgIC8vIHNjcm9sbCB0byBlbmRcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZChjaGlsZEdyaWQsICdib3R0b20nLCAoKSA9PiB0aGlzLmZvY3VzUHJldkNoaWxkKGVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgZ3JpZCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgbGFzdFJvd0luQ2hpbGQgPSBjaGlsZEdyaWQuZ2V0Um93QnlJbmRleChsYXN0SW5kZXgpO1xuICAgICAgICAgICAgY29uc3QgaXNDaGlsZEdyaWQgPSBsYXN0Um93SW5DaGlsZC5uYXRpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpZ3gtY2hpbGQtZ3JpZC1yb3cnO1xuICAgICAgICAgICAgaWYgKGlzQ2hpbGRHcmlkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c1ByZXZDaGlsZChsYXN0Um93SW5DaGlsZC5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUsIHZpc2libGVDb2x1bW5JbmRleCwgY2hpbGRHcmlkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c1ByZXZSb3cobGFzdFJvd0luQ2hpbGQubmF0aXZlRWxlbWVudCwgdmlzaWJsZUNvbHVtbkluZGV4LCBjaGlsZEdyaWQsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZm9jdXNQcmV2KHZpc2libGVDb2x1bW5JbmRleCwgZ3JpZD8pIHtcbiAgICAgICAgY29uc3QgY3VyckdyaWQgPSBncmlkIHx8IHRoaXMuZ3JpZDtcbiAgICAgICAgbGV0IHBhcmVudENvbnRhaW5lciA9IHRoaXMuZ2V0Q2hpbGRDb250YWluZXIoY3VyckdyaWQpO1xuICAgICAgICBsZXQgY2hpbGRSb3dDb250YWluZXIgPSB0aGlzLmdldENoaWxkR3JpZFJvd0NvbnRhaW5lcihjdXJyR3JpZCk7XG4gICAgICAgIGNvbnN0IHByZXZJc1NpYmxpbmdDaGlsZCA9ICEhY2hpbGRSb3dDb250YWluZXIucHJldmlvdXNFbGVtZW50U2libGluZztcbiAgICAgICAgbGV0IHByZXYgPSBjaGlsZFJvd0NvbnRhaW5lci5wcmV2aW91c0VsZW1lbnRTaWJsaW5nIHx8IHBhcmVudENvbnRhaW5lci5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICBpZiAocHJldikge1xuICAgICAgICAgICAgaWYgKHByZXZJc1NpYmxpbmdDaGlsZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNQcmV2Q2hpbGQocHJldiwgdmlzaWJsZUNvbHVtbkluZGV4LCBjdXJyR3JpZC5wYXJlbnQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzUHJldlJvdyhwcmV2LCB2aXNpYmxlQ29sdW1uSW5kZXgsIGN1cnJHcmlkLnBhcmVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQoY3VyckdyaWQucGFyZW50LCAncHJldicsXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICBwYXJlbnRDb250YWluZXIgPSB0aGlzLmdldENoaWxkQ29udGFpbmVyKGdyaWQpO1xuICAgICAgICAgICAgY2hpbGRSb3dDb250YWluZXIgPSB0aGlzLmdldENoaWxkR3JpZFJvd0NvbnRhaW5lcihncmlkKTtcbiAgICAgICAgICAgIHByZXYgPSBjaGlsZFJvd0NvbnRhaW5lci5wcmV2aW91c0VsZW1lbnRTaWJsaW5nIHx8IHBhcmVudENvbnRhaW5lci5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICAgICAgaWYgKHByZXZJc1NpYmxpbmdDaGlsZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNQcmV2Q2hpbGQocHJldiwgdmlzaWJsZUNvbHVtbkluZGV4LCBjdXJyR3JpZC5wYXJlbnQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzUHJldlJvdyhwcmV2LCB2aXNpYmxlQ29sdW1uSW5kZXgsIGN1cnJHcmlkLnBhcmVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TmV4dFBhcmVudEluZm8oZ3JpZCkge1xuICAgICAgICAvLyBmaW5kIG5leHQgcGFyZW50IHRoYXQgaXMgbm90IGF0IGJvdHRvbVxuICAgICAgICBsZXQgY3VyckdyaWQgPSBncmlkLnBhcmVudDtcbiAgICAgICAgbGV0IG5leHRFbGVtID0gdGhpcy5nZXRDaGlsZENvbnRhaW5lcihncmlkKS5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICAgIHdoaWxlICghbmV4dEVsZW0gJiYgY3VyckdyaWQucGFyZW50ICE9PSBudWxsKSB7XG4gICAgICAgICAgICBuZXh0RWxlbSA9IHRoaXMuZ2V0Q2hpbGRDb250YWluZXIoY3VyckdyaWQpLm5leHRFbGVtZW50U2libGluZztcbiAgICAgICAgICAgIGN1cnJHcmlkID0gY3VyckdyaWQucGFyZW50O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHsgZ3JpZDogY3VyckdyaWQsIG5leHRFbGVtZW50OiBuZXh0RWxlbX07XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0TmV4dFNjcm9sbGFibGUoZ3JpZCkge1xuICAgICAgICBsZXQgY3VyckdyaWQgPSBncmlkLnBhcmVudDtcbiAgICAgICAgaWYgKCFjdXJyR3JpZCkge1xuICAgICAgICAgICAgcmV0dXJuIHtncmlkOiBncmlkLCBwcmV2OiBudWxsIH07XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG5vblNjcm9sbGFibGUgPSBjdXJyR3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRWZXJ0aWNhbFNjcm9sbCgpLnNjcm9sbFRvcCA9PT0gMDtcbiAgICAgICAgbGV0IHByZXYgPSBncmlkO1xuICAgICAgICB3aGlsZSAobm9uU2Nyb2xsYWJsZSAmJiBjdXJyR3JpZC5wYXJlbnQgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHByZXYgPSBjdXJyR3JpZDtcbiAgICAgICAgICAgIGN1cnJHcmlkID0gY3VyckdyaWQucGFyZW50O1xuICAgICAgICAgICAgbm9uU2Nyb2xsYWJsZSA9IGN1cnJHcmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFZlcnRpY2FsU2Nyb2xsKCkuc2Nyb2xsVG9wID09PSAwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7Z3JpZDogY3VyckdyaWQsIHByZXY6IHByZXYgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvY3VzTmV4dCh2aXNpYmxlQ29sdW1uSW5kZXgsIGdyaWQ/KSB7XG4gICAgICAgIGNvbnN0IGN1cnJHcmlkID0gZ3JpZCB8fCB0aGlzLmdyaWQ7XG4gICAgICAgIGNvbnN0IHBhcmVudEluZm8gPSB0aGlzLmdldE5leHRQYXJlbnRJbmZvKGN1cnJHcmlkKTtcbiAgICAgICAgY29uc3QgbmV4dFBhcmVudEdyaWQgPSBwYXJlbnRJbmZvLmdyaWQ7XG4gICAgICAgIGxldCBuZXh0UGFyZW50RWxlbSA9IHBhcmVudEluZm8ubmV4dEVsZW1lbnQ7XG4gICAgICAgIGxldCBjaGlsZFJvd0NvbnRhaW5lciA9IHRoaXMuZ2V0Q2hpbGRHcmlkUm93Q29udGFpbmVyKGN1cnJHcmlkKTtcbiAgICAgICAgY29uc3QgbmV4dElzU2libGluZ0NoaWxkID0gISFjaGlsZFJvd0NvbnRhaW5lci5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGxldCBuZXh0ID0gY2hpbGRSb3dDb250YWluZXIubmV4dEVsZW1lbnRTaWJsaW5nIHx8IG5leHRQYXJlbnRFbGVtO1xuICAgICAgICBjb25zdCB2ZXJ0aWNhbFNjcm9sbCA9IG5leHRQYXJlbnRHcmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFZlcnRpY2FsU2Nyb2xsKCk7XG4gICAgICAgIGlmIChuZXh0KSB7XG4gICAgICAgICAgICBpZiAobmV4dElzU2libGluZ0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c05leHRDaGlsZChuZXh0LCB2aXNpYmxlQ29sdW1uSW5kZXgsIG5leHRQYXJlbnRHcmlkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c05leHRSb3cobmV4dCwgdmlzaWJsZUNvbHVtbkluZGV4LCBncmlkIHx8IG5leHRQYXJlbnRHcmlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh2ZXJ0aWNhbFNjcm9sbC5zY3JvbGxUb3AgIT09XG4gICAgICAgICAgICB2ZXJ0aWNhbFNjcm9sbC5zY3JvbGxIZWlnaHQgLSBuZXh0UGFyZW50R3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JDb250YWluZXJTaXplICkge1xuICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKG5leHRQYXJlbnRHcmlkLCAnbmV4dCcsXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgbmV4dFBhcmVudEVsZW0gPSBwYXJlbnRJbmZvLm5leHRFbGVtZW50O1xuICAgICAgICAgICAgICAgIGNoaWxkUm93Q29udGFpbmVyID0gdGhpcy5nZXRDaGlsZEdyaWRSb3dDb250YWluZXIoKTtcbiAgICAgICAgICAgICAgICBuZXh0ID0gY2hpbGRSb3dDb250YWluZXIubmV4dEVsZW1lbnRTaWJsaW5nIHx8IG5leHRQYXJlbnRFbGVtO1xuICAgICAgICAgICAgICAgIGlmIChuZXh0ICYmIG5leHRJc1NpYmxpbmdDaGlsZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dENoaWxkKG5leHQsIHZpc2libGVDb2x1bW5JbmRleCwgbmV4dFBhcmVudEdyaWQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dFJvdyhuZXh0LCB2aXNpYmxlQ29sdW1uSW5kZXgsIGdyaWQgfHwgbmV4dFBhcmVudEdyaWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0TmV4dFNjcm9sbGFibGVEb3duKGdyaWQpIHtcbiAgICAgICAgbGV0IGN1cnJHcmlkID0gZ3JpZC5wYXJlbnQ7XG4gICAgICAgIGlmICghY3VyckdyaWQpIHtcbiAgICAgICAgICAgIHJldHVybiB7Z3JpZDogZ3JpZCwgcHJldjogbnVsbCB9O1xuICAgICAgICB9XG4gICAgICAgIGxldCBzY3JvbGxUb3AgPSBjdXJyR3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRWZXJ0aWNhbFNjcm9sbCgpLnNjcm9sbFRvcDtcbiAgICAgICAgbGV0IHNjcm9sbEhlaWdodCA9IGN1cnJHcmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFZlcnRpY2FsU2Nyb2xsKCkuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICBsZXQgbm9uU2Nyb2xsYWJsZSA9IHNjcm9sbEhlaWdodCA9PT0gMCB8fFxuICAgICAgICBNYXRoLnJvdW5kKHNjcm9sbFRvcCArICBjdXJyR3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JDb250YWluZXJTaXplKSA9PT0gc2Nyb2xsSGVpZ2h0O1xuICAgICAgICBsZXQgcHJldiA9IGdyaWQ7XG4gICAgICAgIHdoaWxlIChub25TY3JvbGxhYmxlICYmIGN1cnJHcmlkLnBhcmVudCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcHJldiA9IGN1cnJHcmlkO1xuICAgICAgICAgICAgY3VyckdyaWQgPSBjdXJyR3JpZC5wYXJlbnQ7XG4gICAgICAgICAgICBzY3JvbGxUb3AgPSBjdXJyR3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRWZXJ0aWNhbFNjcm9sbCgpLnNjcm9sbFRvcDtcbiAgICAgICAgICAgIHNjcm9sbEhlaWdodCA9IGN1cnJHcmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFZlcnRpY2FsU2Nyb2xsKCkuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgbm9uU2Nyb2xsYWJsZSA9IHNjcm9sbEhlaWdodCA9PT0gMCB8fFxuICAgICAgICAgICAgTWF0aC5yb3VuZChzY3JvbGxUb3AgKyAgY3VyckdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuaWd4Rm9yQ29udGFpbmVyU2l6ZSkgPT09IHNjcm9sbEhlaWdodDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge2dyaWQ6IGN1cnJHcmlkLCBwcmV2OiBwcmV2IH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0TWluQm90dG9tKGdyaWQpIHtcbiAgICAgICAgbGV0IGN1cnJHcmlkID0gZ3JpZDtcbiAgICAgICAgbGV0IGJvdHRvbSA9IGN1cnJHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xuICAgICAgICB3aGlsZSAoY3VyckdyaWQucGFyZW50KSB7XG4gICAgICAgICAgICBjdXJyR3JpZCA9IGN1cnJHcmlkLnBhcmVudDtcbiAgICAgICAgICAgIGJvdHRvbSA9IE1hdGgubWluKGJvdHRvbSwgY3VyckdyaWQudGJvZHkubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b20pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBib3R0b207XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0TWF4VG9wKGdyaWQpIHtcbiAgICAgICAgbGV0IGN1cnJHcmlkID0gZ3JpZDtcbiAgICAgICAgbGV0IHRvcCA9IGN1cnJHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wO1xuICAgICAgICB3aGlsZSAoY3VyckdyaWQucGFyZW50KSB7XG4gICAgICAgICAgICBjdXJyR3JpZCA9IGN1cnJHcmlkLnBhcmVudDtcbiAgICAgICAgICAgIHRvcCA9IE1hdGgubWF4KHRvcCwgY3VyckdyaWQudGJvZHkubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3ApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0b3A7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmb2N1c05leHRSb3coZWxlbSwgdmlzaWJsZUNvbHVtbkluZGV4LCBncmlkLCBpc1N1bW1hcnk/KSB7XG4gICAgICAgIGNvbnN0IGNlbGxTZWxlY3RvciA9IHRoaXMuZ2V0Q2VsbFNlbGVjdG9yKHZpc2libGVDb2x1bW5JbmRleCwgaXNTdW1tYXJ5KTtcbiAgICAgICAgaWYgKGdyaWQubmF2aWdhdGlvbi5pc0NvbHVtbkZ1bGx5VmlzaWJsZSh2aXNpYmxlQ29sdW1uSW5kZXgpICYmIGdyaWQubmF2aWdhdGlvbi5pc0NvbHVtbkxlZnRGdWxseVZpc2libGUodmlzaWJsZUNvbHVtbkluZGV4KSkge1xuICAgICAgICAgICAgY29uc3QgY2VsbCA9XG4gICAgICAgICAgICBlbGVtLnF1ZXJ5U2VsZWN0b3IoYCR7Y2VsbFNlbGVjdG9yfVtkYXRhLXZpc2libGVJbmRleD1cIiR7dmlzaWJsZUNvbHVtbkluZGV4fVwiXWApO1xuICAgICAgICAgICAgY29uc3QgY2xvc2VzdFNjcm9sbGFibGVHcmlkID0gdGhpcy5nZXROZXh0U2Nyb2xsYWJsZURvd24oZ3JpZCkuZ3JpZDtcbiAgICAgICAgICAgIC8vIGNvbnN0IGRpZmYgPSBjZWxsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmJvdHRvbSAtIGdyaWQucm9vdEdyaWQudGJvZHkubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207XG4gICAgICAgICAgICBjb25zdCBncmlkQm90dG9tID0gdGhpcy5fZ2V0TWluQm90dG9tKGdyaWQpO1xuICAgICAgICAgICAgY29uc3QgZGlmZiA9IGNlbGwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tIC0gZ3JpZEJvdHRvbTtcbiAgICAgICAgICAgIGNvbnN0IGluVmlldyA9ICBkaWZmIDw9IDA7XG4gICAgICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSBjbG9zZXN0U2Nyb2xsYWJsZUdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0VmVydGljYWxTY3JvbGwoKS5zY3JvbGxUb3A7XG4gICAgICAgICAgICBjb25zdCBzY3JvbGxIZWlnaHQgPSBjbG9zZXN0U2Nyb2xsYWJsZUdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0VmVydGljYWxTY3JvbGwoKS5zY3JvbGxIZWlnaHQ7XG4gICAgICAgICAgICBjb25zdCBjYW5TY3JvbGwgPSAhKHNjcm9sbEhlaWdodCA9PT0gMCB8fFxuICAgICAgICBNYXRoLnJvdW5kKHNjcm9sbFRvcCArICBjbG9zZXN0U2Nyb2xsYWJsZUdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuaWd4Rm9yQ29udGFpbmVyU2l6ZSkgPT09IHNjcm9sbEhlaWdodCk7XG4gICAgICAgICAgICBpZiAoIWluVmlldyAmJiBjYW5TY3JvbGwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQoY2xvc2VzdFNjcm9sbGFibGVHcmlkLCBkaWZmLCAoKSA9PiBjZWxsLmZvY3VzKHsgcHJldmVudFNjcm9sbDogdHJ1ZSB9KSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNlbGwuZm9jdXMoeyBwcmV2ZW50U2Nyb2xsOiB0cnVlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgY2VsbEVsZW0gPSBlbGVtLnF1ZXJ5U2VsZWN0b3IoYCR7Y2VsbFNlbGVjdG9yfWApO1xuICAgICAgICAgICAgY29uc3Qgcm93SW5kZXggPSBwYXJzZUludChjZWxsRWxlbS5nZXRBdHRyaWJ1dGUoJ2RhdGEtcm93aW5kZXgnKSwgMTApO1xuICAgICAgICAgICAgZ3JpZC5uYXZpZ2F0aW9uLnBlcmZvcm1Ib3Jpem9udGFsU2Nyb2xsVG9DZWxsKHJvd0luZGV4LCB2aXNpYmxlQ29sdW1uSW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmb2N1c1ByZXZSb3coZWxlbSwgdmlzaWJsZUNvbHVtbkluZGV4LCBncmlkLCBpbkNoaWxkPywgaXNTdW1tYXJ5Pykge1xuICAgICAgICBpZiAoZ3JpZC5uYXZpZ2F0aW9uLmlzQ29sdW1uRnVsbHlWaXNpYmxlKHZpc2libGVDb2x1bW5JbmRleCkgJiYgZ3JpZC5uYXZpZ2F0aW9uLmlzQ29sdW1uTGVmdEZ1bGx5VmlzaWJsZSh2aXNpYmxlQ29sdW1uSW5kZXgpKSB7XG4gICAgICAgICAgICBjb25zdCBjZWxsU2VsZWN0b3IgPSB0aGlzLmdldENlbGxTZWxlY3Rvcih2aXNpYmxlQ29sdW1uSW5kZXgsIGlzU3VtbWFyeSk7XG4gICAgICAgICAgICBjb25zdCBjZWxscyA9ICBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoYCR7Y2VsbFNlbGVjdG9yfVtkYXRhLXZpc2libGVJbmRleD1cIiR7dmlzaWJsZUNvbHVtbkluZGV4fVwiXWApO1xuICAgICAgICAgICAgbGV0IGNlbGwgPSBjZWxsc1tjZWxscy5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgIGNvbnN0IHJJbmRleCA9IHBhcnNlSW50KGVsZW0uZ2V0QXR0cmlidXRlKCdkYXRhLXJvd2luZGV4JyksIDEwKTtcbiAgICAgICAgICAgIGNvbnN0IHNjckdyaWQgPSBncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFZlcnRpY2FsU2Nyb2xsKCkuc2Nyb2xsVG9wICE9PSAwID8gZ3JpZCA6XG4gICAgICAgICAgICAgdGhpcy5nZXROZXh0U2Nyb2xsYWJsZShncmlkKS5ncmlkO1xuICAgICAgICAgICAgY29uc3QgdG9wR3JpZCA9IHNjckdyaWQudGJvZHkubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3AgPlxuICAgICAgICAgICAgZ3JpZC5yb290R3JpZC50Ym9keS5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCA/IHNjckdyaWQgOiBncmlkLnJvb3RHcmlkO1xuICAgICAgICAgICAgY29uc3QgZ3JpZFRvcCA9IHRoaXMuX2dldE1heFRvcChncmlkKTtcbiAgICAgICAgICAgIGNvbnN0IHNjclRvcCA9IHNjckdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0VmVydGljYWxTY3JvbGwoKS5zY3JvbGxUb3A7XG4gICAgICAgICAgICBjb25zdCBkaWZmID0gY2VsbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b20gLVxuICAgICAgICAgICAgY2VsbC5vZmZzZXRIZWlnaHQgLSBncmlkVG9wO1xuICAgICAgICAgICAgaWYgKHNjclRvcCAhPT0gMCAmJiBkaWZmIDwgMCAmJiAhaW5DaGlsZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZChzY3JHcmlkLCBkaWZmLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gIWlzU3VtbWFyeSA/IGdyaWQubmF2aWdhdGlvbi5nZXRSb3dCeUluZGV4KHJJbmRleCkgOiBlbGVtO1xuICAgICAgICAgICAgICAgICAgICBjZWxsID0gZWwucXVlcnlTZWxlY3RvckFsbChgJHtjZWxsU2VsZWN0b3J9W2RhdGEtdmlzaWJsZUluZGV4PVwiJHt2aXNpYmxlQ29sdW1uSW5kZXh9XCJdYClbMF07XG4gICAgICAgICAgICAgICAgICAgIGNlbGwuZm9jdXMoeyBwcmV2ZW50U2Nyb2xsOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChkaWZmIDwgMCAmJiBpbkNoaWxkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKHRvcEdyaWQsIGRpZmYsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2VsbC5mb2N1cyh7IHByZXZlbnRTY3JvbGw6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNlbGwuZm9jdXMoeyBwcmV2ZW50U2Nyb2xsOiB0cnVlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ob3Jpem9udGFsU2Nyb2xsR3JpZFRvSW5kZXgoZ3JpZCwgdmlzaWJsZUNvbHVtbkluZGV4LCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c1ByZXZSb3coZWxlbSwgdmlzaWJsZUNvbHVtbkluZGV4LCBncmlkLCBpbkNoaWxkLCBpc1N1bW1hcnkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhvcml6b250YWxTY3JvbGxHcmlkVG9JbmRleChncmlkLCB2aXNpYmxlQ29sdW1uSW5kZXgsIGNhbGxCYWNrRnVuYykge1xuICAgICAgICBjb25zdCB1bnBpbm5lZEluZGV4ID0gdGhpcy5nZXRDb2x1bW5VbnBpbm5lZEluZGV4KHZpc2libGVDb2x1bW5JbmRleCk7XG4gICAgICAgIGdyaWQucGFyZW50VmlydERpci5vbkNodW5rTG9hZFxuICAgICAgICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoY2FsbEJhY2tGdW5jKTtcbiAgICAgICAgZ3JpZC5kYXRhUm93TGlzdC50b0FycmF5KClbMF0udmlydERpclJvdy5zY3JvbGxUbyh1bnBpbm5lZEluZGV4KTtcbiAgICB9XG4gICAgcHJpdmF0ZSBzY3JvbGxHcmlkKGdyaWQsIHRhcmdldCwgY2FsbEJhY2tGdW5jKSB7XG4gICAgICAgIGdyaWQubmF0aXZlRWxlbWVudC5mb2N1cyh7cHJldmVudFNjcm9sbDogdHJ1ZX0pO1xuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5hZGRTY3JvbGxUb3AodGFyZ2V0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc3dpdGNoICh0YXJnZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAndG9wJyA6IGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc2Nyb2xsVG8oMCk7IGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdib3R0b20nIDogZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxUbyhncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmlneEZvck9mLmxlbmd0aCAtIDEpOyBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbmV4dCcgOiAgZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxOZXh0KCk7IGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdwcmV2JyA6ICBncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLnNjcm9sbFByZXYoKTsgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5vbkNodW5rTG9hZFxuICAgICAgICAgICAgICAgIC5waXBlKGZpcnN0KCkpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShjYWxsQmFja0Z1bmMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9uYXZpZ2F0ZVVwSW5DaGlsZChyb3dFbGVtZW50LCBjdXJyZW50Um93SW5kZXgsIHZpc2libGVDb2x1bW5JbmRleCkge1xuICAgICAgICBjb25zdCBwcmV2RWxlbSA9IHJvd0VsZW1lbnQucHJldmlvdXNFbGVtZW50U2libGluZztcbiAgICAgICAgY29uc3Qgc2Nyb2xsYWJsZSA9IHRoaXMuZ2V0TmV4dFNjcm9sbGFibGUodGhpcy5ncmlkKTtcbiAgICAgICAgY29uc3QgZ3JpZCA9IHNjcm9sbGFibGUuZ3JpZDtcbiAgICAgICAgY29uc3Qgc2NyVG9wID0gZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRWZXJ0aWNhbFNjcm9sbCgpLnNjcm9sbFRvcDtcbiAgICAgICAgY29uc3QgY29udGFpbmVyVG9wID0gc2Nyb2xsYWJsZS5wcmV2Lm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZS5wYXJlbnROb2RlLnBhcmVudE5vZGUucGFyZW50Tm9kZTtcbiAgICAgICAgY29uc3QgdG9wID0gcGFyc2VJbnQoY29udGFpbmVyVG9wLnN0eWxlLnRvcCwgMTApO1xuICAgICAgICBpZiAoc2NyVG9wICE9PSAwICYmIHRvcCA8IDApIHtcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZChncmlkLCAtcHJldkVsZW0ub2Zmc2V0SGVpZ2h0LFxuICAgICAgICAgICAgICAgICgpID0+IHN1cGVyLm5hdmlnYXRlVXAocm93RWxlbWVudCwgeyByb3c6IGN1cnJlbnRSb3dJbmRleCwgY29sdW1uOiB2aXNpYmxlQ29sdW1uSW5kZXh9KSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdXBlci5uYXZpZ2F0ZVVwKHJvd0VsZW1lbnQsIHsgcm93OiBjdXJyZW50Um93SW5kZXgsIGNvbHVtbjogdmlzaWJsZUNvbHVtbkluZGV4fSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9uYXZpZ2F0ZURvd25JbkNoaWxkKHJvd0VsZW1lbnQsIGN1cnJlbnRSb3dJbmRleCwgdmlzaWJsZUNvbHVtbkluZGV4KSB7XG4gICAgICAgIGNvbnN0IG5leHRFbGVtID0gcm93RWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGNvbnN0IGNoaWxkQ29udGFpbmVyID0gdGhpcy5ncmlkLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xuICAgICAgICBjb25zdCBkaWZmID1cbiAgICAgICAgY2hpbGRDb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tIC0gdGhpcy5ncmlkLnJvb3RHcmlkLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xuICAgICAgICBjb25zdCBlbmRJc1Zpc2libGUgPSBkaWZmIDwgMDtcbiAgICAgICAgY29uc3Qgc2Nyb2xsYWJsZSA9IHRoaXMuZ2V0TmV4dFNjcm9sbGFibGVEb3duKHRoaXMuZ3JpZCk7XG4gICAgICAgIGNvbnN0IGdyaWQgPSBzY3JvbGxhYmxlLmdyaWQ7XG4gICAgICAgIGlmICghZW5kSXNWaXNpYmxlKSB7XG4gICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQoZ3JpZCwgbmV4dEVsZW0ub2Zmc2V0SGVpZ2h0LFxuICAgICAgICAgICAgICAgICgpID0+IHN1cGVyLm5hdmlnYXRlRG93bihyb3dFbGVtZW50LCB7IHJvdzogY3VycmVudFJvd0luZGV4LCBjb2x1bW46IHZpc2libGVDb2x1bW5JbmRleH0pKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLm5hdmlnYXRlRG93bihyb3dFbGVtZW50LCB7IHJvdzogY3VycmVudFJvd0luZGV4LCBjb2x1bW46IHZpc2libGVDb2x1bW5JbmRleH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDbG9zZXN0RWxlbUJ5VGFnKHNvdXJjZUVsZW0sIHRhcmdldFRhZykge1xuICAgICAgICBsZXQgcmVzdWx0ID0gc291cmNlRWxlbTtcbiAgICAgICAgd2hpbGUgKHJlc3VsdCAhPT0gbnVsbCAmJiByZXN1bHQubm9kZVR5cGUgPT09IDEpIHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSB0YXJnZXRUYWcudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQgPSByZXN1bHQucGFyZW50Tm9kZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG4iXX0=